# v_system_authority_effects.txt — V1–V5 Authority Ledger (MOD)
# [DATE] 2025-12-30
#
# This file intentionally removes legacy Authority Ledger formulas/variables.
# It defines ONLY safe placeholder effects until per-province aggregation primitives are confirmed.
#
# NOT DEFINED IN REPO SOURCES:
# - A proven province-iteration + location-iteration pattern to compute V2.1–V2.3 exactly as spec.
# - A proven way to read location 'population' and 'development' values by script name.
# - A proven monthly hook cadence for this system.
#
# Once confirmed, implement:
# - V2 province aggregates (control avg, pop sum, dev sum)
# - V3 routing, governance composite, bases
# - V4 net + TA accumulation (subject halving)
# - V5 rank evaluation from thresholds

al_authority_monthly_update_effect = {
    al_v_system_monthly_update_effect = yes
}

al_v_system_monthly_update_effect = {
    # Tick counter (optional)
    if = {
        limit = { NOT = { has_variable = v4_tick } }
        set_variable = { name = v4_tick value = 0 }
    }
    change_variable = { name = v4_tick add = 1 }

    # Ensure V3/V4 storage exists
    if = {
        limit = { NOT = { has_variable = v3_7 } }
        set_variable = { name = v3_7 value = 0 }
    }
    if = {
        limit = { NOT = { has_variable = v3_8 } }
        set_variable = { name = v3_8 value = 0 }
    }
    if = {
        limit = { NOT = { has_variable = v4_ta } }
        set_variable = { name = v4_ta value = 0 }
    }
    if = {
        limit = { NOT = { has_variable = v5_t_rank } }
        set_variable = { name = v5_t_rank value = 0 }
    }

    # Debug display: total population/dev/locations
    set_variable = { name = al_total_population value = total_population }
    set_variable = { name = al_total_development value = total_development }
    set_variable = { name = al_total_locations value = num_locations }

    # V2.5: stability scalar
    set_variable = { name = al_v2_stability_scalar value = stability }
    change_variable = { name = al_v2_stability_scalar add = 100 }
    change_variable = { name = al_v2_stability_scalar divide = 200 }
    change_variable = { name = al_v2_stability_scalar multiply = 3.75 }
    change_variable = { name = al_v2_stability_scalar add = 0.25 }

    # V2.6: government power scalar
    set_variable = { name = al_v2_gov_power_scalar value = government_power }
    change_variable = { name = al_v2_gov_power_scalar divide = 100 }
    change_variable = { name = al_v2_gov_power_scalar multiply = 3.75 }
    change_variable = { name = al_v2_gov_power_scalar add = 0.25 }

    # V3.2: governance composite
    set_variable = { name = al_v3_governance value = var:al_v2_stability_scalar }
    change_variable = { name = al_v3_governance add = var:al_v2_gov_power_scalar }
    change_variable = { name = al_v3_governance divide = 2 }

    # V3.7/V3.8: reset country bases
    set_variable = { name = v3_7 value = 0 }
    set_variable = { name = v3_8 value = 0 }

    every_owned_province = {
        # V2.1–V2.3: province aggregates
        set_variable = { name = al_v2_control_sum value = 0 }
        set_variable = { name = al_v2_location_count value = 0 }
        set_variable = { name = al_v2_population_sum value = 0 }
        set_variable = { name = al_v2_development_sum value = 0 }

        every_location = {
            change_variable = { name = al_v2_control_sum add = control }
            change_variable = { name = al_v2_location_count add = 1 }
            change_variable = { name = al_v2_population_sum add = population }
            change_variable = { name = al_v2_development_sum add = development }
        }

        # V2.1: control average
        set_variable = { name = al_v2_control_avg value = 0 }
        if = {
            limit = { check_variable = { name = al_v2_location_count value > 0 } }
            set_variable = { name = al_v2_control_avg value = var:al_v2_control_sum }
            change_variable = { name = al_v2_control_avg divide = var:al_v2_location_count }
        }

        # V2.4: control scalar
        set_variable = { name = al_v2_control_scaled value = var:al_v2_control_avg }
        change_variable = { name = al_v2_control_scaled multiply = 0.015 }
        set_variable = { name = al_v2_control_scalar value = 2.0 }
        change_variable = { name = al_v2_control_scalar subtract = var:al_v2_control_scaled }

        # V3.3/V3.4: ready outputs
        set_variable = { name = al_v3_central_pop value = 0 }
        set_variable = { name = al_v3_central_dev value = 0 }
        set_variable = { name = al_v3_local_pop value = 0 }
        set_variable = { name = al_v3_local_dev value = 0 }

        if = {
            limit = {
                any_location = {
                    limit = { is_capital = yes }
                }
            }
            set_variable = { name = al_v3_central_pop value = var:al_v2_population_sum }
            change_variable = { name = al_v3_central_pop multiply = var:al_v3_governance }
            set_variable = { name = al_v3_central_dev value = var:al_v2_development_sum }
            change_variable = { name = al_v3_central_dev multiply = var:al_v3_governance }
        }
        else = {
            set_variable = { name = al_v3_local_pop value = var:al_v2_population_sum }
            change_variable = { name = al_v3_local_pop multiply = var:al_v2_control_scalar }
            set_variable = { name = al_v3_local_dev value = var:al_v2_development_sum }
            change_variable = { name = al_v3_local_dev multiply = var:al_v2_control_scalar }
        }

        # V3.5/V3.6: province bases
        set_variable = { name = al_v3_central_base value = var:al_v3_central_pop }
        change_variable = { name = al_v3_central_base multiply = var:al_v3_central_dev }
        set_variable = { name = al_v3_local_base value = var:al_v3_local_pop }
        change_variable = { name = al_v3_local_base multiply = var:al_v3_local_dev }

        # V3.7/V3.8: country base totals
        change_variable = { name = v3_7 add = var:al_v3_central_base }
        change_variable = { name = v3_8 add = var:al_v3_local_base }
    }

    # V4.1/V4.2: role-aware central/local flow
    set_variable = { name = v4_1 value = var:v3_7 }
    set_variable = { name = v4_2 value = var:v3_8 }
    if = {
        limit = { is_subject = yes }
        change_variable = { name = v4_1 multiply = 0.5 }
        change_variable = { name = v4_2 multiply = 0.5 }
    }

    # V4.3: net authority flow (per tick)
    set_variable = { name = v4_3 value = var:v4_1 }
    change_variable = { name = v4_3 subtract = var:v4_2 }

    # V4.4: title authority accumulation
    change_variable = { name = v4_ta add = var:v4_3 }

}
