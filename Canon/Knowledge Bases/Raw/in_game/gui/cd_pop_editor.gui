template choose_culture_list {
	ContextualTooltipType = {
		blockoverride "title_text" {
			margin_left = 5
			raw_text = "Select Culture"
		}

		blockoverride "concept_link" {
			text = [culture|E]
		}

		blockoverride "tooltip_content" {
			widget = {
				layoutpolicy_horizontal = expanding
				size = { -1 400 }

				filtered_sorted_list = {
					datacontext = "[CDPopEditor.GetCulturesSortSearch]"
			
					blockoverride "sort_buttons_filtered_list" {
			
						sort_by_key_button = {
							name = "name"
							using = layoutpolicy_expanding
						}
					}
			
					blockoverride "scroll_list_content" {
						datamodel = "[CDPopEditor.GetCultures]"
						addcolumn = 100%
						addrow = 25
						setitemsizefromcell = yes

						item = {
							widget = {
								background = {
									visible = "[IsOdd_int32(PdxGuiWidget.GetIndexInDataModel)]"
									using = color_white_texture
									alpha = 0.1
								}
								
								hbox = {
									margin = { 20 0 }

									button = {
										using = layoutpolicy_expanding
										align = left|nobaseline

										tagtooltip_enabled = yes
										tooltip = "[Culture.GetName]"
										text = "[Culture.GetNameWithNoTooltip]"
										default_format = "#yellow_titles"

										sort_by_highlight = {
											name = "name"
										}

										onclick = "[PopEntry.SelectCulture(Culture.Self)]"
									}
								}
							}
						}
					}
				}
			}
		}
	}
}

template choose_religion_list {
	ContextualTooltipType = {
		blockoverride "title_text" {
			raw_text = "Select Religion"
		}

		blockoverride "concept_link" {
			text = [religion|E]
		}

		blockoverride "tooltip_content" {
			widget = {
				layoutpolicy_horizontal = expanding
				size = { -1 400 }

				filtered_sorted_list = {
					datacontext = "[CDPopEditor.GetReligionsSortSearch]"
					blockoverride "sort_buttons_filtered_list" {
						spacing = 5
						sort_by_key_button = {
							name = "name"
							using = layoutpolicy_expanding
						}
					}

					blockoverride "scroll_list_content" {
						datamodel = "[CDPopEditor.GetReligions]"
						addcolumn = 100%
						addrow = 25
						setitemsizefromcell = yes

						item = {
							widget = {
								background = {
									visible = "[IsOdd_int32(PdxGuiWidget.GetIndexInDataModel)]"
									using = color_white_texture
									alpha = 0.1
								}
								
								hbox = {
									margin = { 20 0 }

									button = {
										using = layoutpolicy_expanding
										align = left|nobaseline

										tagtooltip_enabled = yes
										tooltip = "[Religion.GetName]"
										text = "[Religion.GetNameWithNoTooltip]"
										default_format = "#yellow_titles"

										sort_by_highlight = {
											name = "name"
										}

										onclick = "[PopEntry.SelectReligion(Religion.Self)]"
									}
								}
							}
						}
					}
				}
			}
		}
	}
}

types CDCDPopEditor
{
	# type pop_editor_number_edit_box = editbox {
	# 	using = Font_Type_Standard
	# 	alwaystransparent = no
	# 	focuspolicy = all
	# 	multiline = no
	# 	background = {
	# 		margin_left = 0
	# 		margin_right = 0
	# 		margin_bottom = 0
	# 		texture = "gfx/interface_old/from_sulla/list_slot_corner_tiles.dds"
	# 		spriteType = Corneredtiled
	# 		spriteborder = { 10 10 }
	# 		shaderfile = "gfx/FX/pdxgui_default.shader"
	# 	}
	# }

	type population_configuration = scrollarea {
		autoresize_axis = vertical
		autoresizeviewport = yes
		scrollbarpolicy_horizontal = always_off
		
		scrollbar_vertical = {
			using = editor_vertical_scrollbar
		}

		scrollwidget = {
			vbox = {
				name = "pop type grid"
				layoutpolicy_horizontal = expanding

				vbox = {
					layoutpolicy_horizontal = expanding
					spacing = 10

					datamodel = "[PopulationConfiguration.GetPopTypes]"
					item = {
						vbox = {
							margin = { 5 5 }
							layoutpolicy_horizontal = expanding

							background = {
								using = color_white_texture
								alpha = 0.1
							}

							hbox = {
								layoutpolicy_horizontal = expanding
								ignoreinvisible = no 
								spacing = 5

								widget = {
									size = { 24 24 }
									ui_direction_button = {
										parentanchor = center
										visible = "[PopTypeEntry.IsToggled]"
										texture = "gfx/interface/buttons/flats/plus_button.dds"
										using = bg_circle
										size = { 16 16 }
										onclick = "[PopTypeEntry.AddNew]"
									}

									text_single = {
										parentanchor = center
										visible = "[Not(PopTypeEntry.IsToggled)]"
										text = "[GetDataModelSize(PopTypeEntry.GetPopEntries)]"
									}
								}

								widget = {
									size = { 24 24 }

									button = {
										texture = "gfx/interface/icons/outliner/arrow_right.dds"
										size = { 24 24 }
										visible = "[Not(PopTypeEntry.IsToggled)]"
										onclick = "[PopTypeEntry.Toggle]"
									}
	
									button = {
										texture = "gfx/interface/icons/outliner/arrow_down.dds"
										size = { 24 24 }
										visible = "[PopTypeEntry.IsToggled]"
										onclick = "[PopTypeEntry.Toggle]"
									}
								}

								text_single = {
									autoresize = yes
									text = "[PopTypeEntry.GetPopType.GetName]"
								}

								expand = {}


								text_single = {
									raw_text = "[PopTypeEntry.GetPercentage]"
								}
								text_single = {
									raw_text = "%"
								}

								expand = {}								

								text_single = {
									raw_text = "Population:"
								}

								editbox_single = {
									maximumsize = { 100 -1 }
									enabled = "[PopulationConfiguration.CanEditPopulation]"
									text = "[PopTypeEntry.GetPopulation]"
									ontextedited = "[PopTypeEntry.RetrievePopulation(PdxGuiWidget.AccessSelf)]"

									blockoverride "editbox_label" {
										raw_text = "Population"
									}
								}
							}

							vbox = {
								layoutpolicy_horizontal = expanding
								visible = "[PopTypeEntry.IsToggled]"

								# List of religion/culture combos
								vbox = {
									layoutpolicy_horizontal = expanding
									spacing = 5

									background = {
										using = color_white_texture
										alpha = 0.1
									}

									visible = "[PopTypeEntry.IsToggled]"
									datamodel = "[PopTypeEntry.GetPopEntries]"
									item = {
										hbox = {
											margin = { 10 0 }
											spacing = 5
											layoutpolicy_horizontal = expanding

											background = {
												visible = "[IsOdd_int32(PdxGuiWidget.GetIndexInDataModel)]"
												using = color_white_texture
												alpha = 0.1
											}

											background = {
												visible = "[CDPopEditor.IsSelected(PopEntry.AccessSelf)]"
												using = color_red_texture
												alpha = 0.5
											}

											button_regular = {
												autoresize = no
												layoutpolicy_horizontal = expanding

												text = "[PopEntry.GetCulture.GetNameWithNoTooltip]"
												onclick = "[CDPopEditor.SelectPop(PopEntry.AccessSelf)]"
												onrightclick = "[CDPopEditor.PickCultureFrom(PopEntry.AccessSelf)]"
												
												tooltipwidget = {
													using = choose_culture_list
												}
											}

											button_regular = {
												autoresize = no
												layoutpolicy_horizontal = expanding

												text = "[PopEntry.GetReligion.GetAdjectiveWithNoTooltip]"
												onclick = "[CDPopEditor.SelectPop(PopEntry.AccessSelf)]"
												onrightclick = "[CDPopEditor.PickReligionFrom(PopEntry.AccessSelf)]"

												tooltipwidget = {
													using = choose_religion_list
												}
											}

											text_single = {
												raw_text = "[PopEntry.GetPercentage]"
											}
											text_single = {
												raw_text = "%"
											}
			
											expand = {}	

											editbox_single = {
												maximumsize = { 70 -1 }
												name = "size"
												text = "[PopEntry.GetSize]"
												ontextedited = "[PopEntry.RetrieveSize(PdxGuiWidget.AccessParent.FindChild('size'))]"
											}

											# x button to remove this entry
											ui_direction_button = {
												texture = "gfx/interface/icons/flat_icons/close_flat_icon.dds"
												using = bg_circle
												size = { 16 16 }
												onclick = "[PopEntry.Remove]"
											}
										}
									}
								}
							}
						}
					}
				}

				expand = {}
			}
		}
	}
}

window = {
	name = "cd_pop_editor"
	input_context = "generic_window"

	using = bg_lateralview
	alwaystransparent = no

	parentanchor = top|left
	size = { 800 850 }
	position = { 5 200 }
	movable = yes
	resizable = yes
	
	widget = {
		size = { 100% -1 }
		allow_outside = yes

		button_close = {
			blockoverride "close_onclick" {
				onclick = "[ExecuteConsoleCommand('cd_pop_editor')]"
			}
		}
	}

	vbox = {
		using = layoutpolicy_expanding
		using = window_margin
		
		window_header = {
			blockoverride "header_text" {
				raw_text = "CD Pop Editor"
			}
		}

		textbox = {
			autoresize = yes
			default_format = "#flavor"
			raw_text = "LMB: select location; RMB: Open location lateral view; Alt+RMB: open location window"
		}

		hbox = {
			using = layoutpolicy_expanding
			using = window_main_tabs_margin_alt
			spacing = 5

			# Template
			vbox = {
				using = layoutpolicy_expanding
				layoutstretchfactor_horizontal = 1
				spacing = 5

				widget = {
					layoutpolicy_horizontal = expanding
					size = { -1 50 }
					hbox = {
						layoutpolicy_horizontal = expanding
						text_single = {
							layoutpolicy_horizontal = expanding
							raw_text = "Template"
						}
	
						button_regular = {
							using = button_resize_to_fit_text
							raw_text = "Reset"
							onclick = "[CDPopEditor.ResetTemplate]"
							using = editor_text
						}
					}
				}
				
				population_configuration = {
					using = layoutpolicy_expanding
					datacontext = "[CDPopEditor.GetTemplate]"
				}
			}

			# Buttons to switch between the two
			vbox = {				
				button_regular = {
					using = button_resize_to_fit_text
					raw_text = ">>"
					raw_tooltip = "Apply template to selection"
					onclick = "[CDPopEditor.ApplyTemplateToSelectedLocation]"
					using = editor_text
				}

				button_regular = {
					using = button_resize_to_fit_text
					raw_text = "<<"
					raw_tooltip = "Make template from selection"
					onclick = "[CDPopEditor.ApplySelectedLocationToTemplate]"
					using = editor_text
				}
			}

			# What's selected
			vbox = {
				using = layoutpolicy_expanding
				layoutstretchfactor_horizontal = 1
				spacing = 8

				widget = {
					layoutpolicy_horizontal = expanding
					size = { -1 50 }					

					vbox = {						
						text_single = {
							layoutpolicy_horizontal = expanding
							raw_text = "Selected Location:"
						}
	
						hbox = {
							layoutpolicy_horizontal = expanding
							spacing = 10

							text_single = {
								autoresize = yes
								text = "[CDPopEditor.GetSelectedLocationText]"
								tooltip = "[CDPopEditor.GetSelectedLocationText]"
							}

							text_single = {
								autoresize = yes
								raw_text = "Total Pops"
							}

							editbox_single = {
								datacontext = "[CDPopEditor.GetSelectedPops]"
								layoutpolicy_horizontal = expanding
								text = "[PopulationConfiguration.GetPopulation]"
								ontextedited = "[PopulationConfiguration.RetrievePopulation(PdxGuiWidget.AccessSelf)]"

								blockoverride "editbox_label" {
									raw_text = "Population"
								}
							}

							button_regular = {
								size = { 40 30 }
								raw_text = "V"
								onclick = "[CDPopEditor.ApplyTotalPopulation]"
							}
						}
					}
				}

				population_configuration = {
					layoutpolicy_vertical = expanding
					layoutpolicy_horizontal = expanding
					datacontext = "[CDPopEditor.GetSelectedPops]"
				}
			}
		}

		# Bottom Buttons
		hbox = {
			layoutpolicy_horizontal = expanding
			spacing = 5
			
			using = window_margin

			expand = {}

			button_regular = {
				using = button_resize_to_fit_text
				raw_text = "Reset To Original"
				onclick = "[CDPopEditor.ResetToOriginal]"
				using = editor_text
			}

			button_regular = {
				using = button_resize_to_fit_text
				raw_text = "Reset"
				enabled = "[CDPopEditor.IsDirty]"
				onclick = "[CDPopEditor.Reset]"
				using = editor_text
			}

			button_regular = {
				using = button_resize_to_fit_text
				raw_text = "Apply"
				enabled = "[CDPopEditor.IsDirty]"
				onclick = "[CDPopEditor.Apply]"
				using = editor_text
			}

			button_regular = {
				using = button_resize_to_fit_text
				raw_text = "Save"
				onclick = "[CDPopEditor.Save]"
				using = editor_text
			}

			icon = {
				size = { 28 28 }
				using = warning_icon_texture
				visible = "[CDPopEditor.HasError]"
				tooltip = "[CDPopEditor.GetLastError]"
			}
		}
	}
}

