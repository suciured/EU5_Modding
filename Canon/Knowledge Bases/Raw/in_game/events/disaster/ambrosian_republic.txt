namespace = ambrosian_republic_disaster

ambrosian_republic_disaster.1 = {
	type = country_event
	category = disaster_event

	title = ambrosian_republic.1.title
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {
					NOT = { has_variable = chose_ally_union }
					is_subject = no
				}
				desc = ambrosian_republic.1.desc
			}
			triggered_desc = {
				trigger = {
					has_variable = chose_ally_union
				}
				desc = ambrosian_republic.1.b.desc
			}
			triggered_desc = {
				trigger = { always = yes }
				desc = ambrosian_republic.1.desc
			}
		}
	}
	image = "gfx/interface/illustrations/disaster/ambrosian_republic_disaster.dds"

	immediate = {
		random_related_country = {
			type = alliance
			limit = { in_union_with = ROOT }
			save_scope_as = target_country 
		}
	}

	option = {
		name = ambrosian_republic.1.a
		add_stability = stability_extreme_bonus
		add_prestige = prestige_extreme_bonus
	}
}

ambrosian_republic_disaster.2 = {
	image = "gfx/interface/illustrations/disaster/ambrosian_republic_disaster.dds"
	hide_portraits = yes
	type = country_event
	category = disaster_event
	fire_only_once = yes
	title = ambrosian_republic.2.title
	desc = ambrosian_republic.2.desc
	trigger = {
		government_type = government_type:monarchy
		country_exists = c:FRA
		country_exists = international_organization:hre.leader_country
		c:FRA = {
			is_subject = no
			government_type = government_type:monarchy
		}
		international_organization:hre.leader_country = {
			government_type = government_type:monarchy
		}
	}

	immediate = {
		c:FRA.ruler_or_regent ?= { save_scope_as = target_character }
		international_organization:hre.leader_country ?= { 
			ruler_or_regent = { save_scope_as = target_character2 } 
		}
	}

	option = {
		name = ambrosian_republic.2.a
		c:FRA = {
			trigger_event_silently = { id = ambrosian_republic_disaster.3 }
		}
		international_organization:hre.leader_country = {
			trigger_event_silently = { id = ambrosian_republic_disaster.4 }
		}
	}
}

ambrosian_republic_disaster.3 = {
	image = "gfx/interface/illustrations/disaster/ambrosian_republic_disaster.dds"
	type = country_event
	category = disaster_event
	title = ambrosian_republic.3.title
	desc = ambrosian_republic.3.desc
	option = {
		name = ambrosian_republic.3.a
		add_casus_belli = {	target = c:MLO	type = casus_belli:cb_claim_throne	}
	}
	option = {
		name = ambrosian_republic.3.b
		add_prestige = prestige_weak_bonus
	}
}

ambrosian_republic_disaster.4 = {
	image = "gfx/interface/illustrations/disaster/ambrosian_republic_disaster.dds"
	type = country_event
	category = disaster_event

	title = ambrosian_republic.4.title
	desc = ambrosian_republic.4.desc
	option = {
		name = ambrosian_republic.4.a
		add_casus_belli = {	target = c:MLO	type = casus_belli:cb_claim_throne	}
	}
	option = {
		name = ambrosian_republic.4.b
		add_prestige = prestige_weak_bonus
	}
}

ambrosian_republic_disaster.5 = {
	image = "gfx/interface/illustrations/disaster/ambrosian_republic_disaster.dds"
	hide_portraits = yes
	type = country_event
	category = disaster_event
	title = {
		first_valid = {
			triggered_desc = {
				trigger = { exists = scope:target_character }
				desc = ambrosian_republic.5.title
			}
			triggered_desc = {
				trigger = { always = yes }
				desc = ambrosian_republic.5.title.fallback
			}
		}
	}
	desc = ambrosian_republic.5.desc

	fire_only_once = yes

	trigger = {
		character:mlo_sforza_script ?= { is_alive = yes }
	}

	immediate = {
		character:mlo_sforza_script = {
			save_scope_as = target_character
		}
	}

	option = {
		name = ambrosian_republic.5.a
		
		custom_tooltip = mlo_sforza_given_influence_tt
		trigger_event_silently = {
			id = ambrosian_republic_disaster.6
			days = { 250 400 }
		}
	}

	option = {
		name = ambrosian_republic.5.b 

		add_stability = stability_mild_bonus
		add_government_power = government_power_mild_bonus
	}
}

scripted_effect sforza_gains_support = {
	create_rebel = {
		category = pretender
		name = sforza_rebellion
		save_scope_as = sforza_rebellion_scope
	}
	character:mlo_sforza_script = { change_character_allegiance = scope:sforza_rebellion_scope }
	random_owned_location = {
		limit = {
			is_capital = no 
		}
		every_pop = {
			limit = {
				owner = root
			}
			add_pop_satisfaction = pop_satisfaction_radical_penalty
			change_pop_allegiance = scope:sforza_rebellion_scope
		}
	}
	random_province = {
		limit = {
			this != root.capital.province
		}
		every_location_in_province = {
			every_pop = {
				limit = {
					owner = root
				}
				add_pop_satisfaction = pop_satisfaction_radical_penalty
				change_pop_allegiance = scope:sforza_rebellion_scope
			}
		}
	}
	scope:sforza_rebellion_scope = {
		add_rebel_progress = 0.9
	}
}

ambrosian_republic_disaster.6 = {
	image = "gfx/interface/illustrations/disaster/ambrosian_republic_disaster.dds"
	type = country_event
	category = disaster_event
	title = ambrosian_republic.6.title
	desc = ambrosian_republic.6.desc

	trigger = {
		exists = character:mlo_sforza_script
		character:mlo_sforza_script = {
			is_alive = yes
		}
	}

	immediate = {
		character:mlo_sforza_script = {
			save_scope_as = target_character
		}
	}
 
	option = {
		name = ambrosian_republic.6.a
		historical_option = yes
		add_stability = stability_mild_penalty
		set_new_ruler = character:mlo_sforza_script
		change_heir_selection = heir_selection:military_dictatorship
		
		trigger_event_silently = {
			id = ambrosian_republic_disaster.7
			days = { 500 1000 }
		}
	}
	option = {
		name = ambrosian_republic.6.b
		add_stability = stability_ultimate_penalty
		custom_tooltip = {
		 	text = sforza_gains_support.tt
			sforza_gains_support = yes
		}
	}
}

ambrosian_republic_disaster.7 = {
	image = "gfx/interface/illustrations/disaster/ambrosian_republic_disaster.dds"
	hide_portraits = yes
	type = country_event
	category = disaster_event

	title = ambrosian_republic.7.title
	desc = ambrosian_republic.7.desc

	trigger = {
		exists = character:mlo_sforza_script
		character:mlo_sforza_script = {
			is_alive = yes
			OR = { 
				this = root.ruler
				this = root.heir
			}
		}
	}

	immediate = {
		random_character = {
			limit = {
				is_adult = yes
				is_ruler = no
			}
			save_scope_as = target_new_ruler
		}
		character:mlo_sforza_script = {
			save_scope_as = target_character
		}
	}

	option = {
		name = ambrosian_republic.7.a
		historical_option = yes
		change_government_type = government_type:monarchy
		remove_reform = government_reform:ambrosian_republic_reform
		add_legitimacy = legitimacy_ultimate_bonus
		add_stability = stability_extreme_bonus
		hidden_effect = { destroy_rebel = scope:sforza_rebellion_scope }

	}
	option = {
		name = ambrosian_republic.7.b
		set_new_ruler = scope:target_new_ruler
		custom_tooltip = {
			text = sforza_gains_support.tt
			sforza_gains_support = yes
		}
	}
	option = {
		name = ambrosian_republic.7.c
		trigger = {
			has_reform = government_reform:ambrosian_republic_reform
			NOT = { succession_law = heir_selection:oligarchic_elective }
		}
		change_heir_selection = heir_selection:oligarchic_elective
		set_new_ruler = scope:target_new_ruler
		custom_tooltip = {
			text = sforza_gains_support.tt
			sforza_gains_support = yes
		}
	}
}

ambrosian_republic_disaster.10 = {
	hide_portraits = yes
	type = country_event
	category = disaster_event
	fire_only_once = yes
	title = flavor_mlo.1.title
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {
					any_related_country = {
						type = alliance
						government_type = government_type:monarchy
						has_ruler = yes
					}
				}
				desc = flavor_mlo.1.desc

			}
			triggered_desc = {
				trigger = { always = yes }
				desc = flavor_mlo.1.desc.no_ally
			}
		}
	}
	image = "gfx/interface/illustrations/disaster/ambrosian_republic_disaster.dds"

	illustration_tags = {
        10 = angry
        10 = interior
    }

	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:burghers_estate background = estate_type:nobles_estate }
		random_related_country = {
			type = alliance
			limit = {
				government_type = government_type:monarchy
				has_ruler = yes
				at_war = no
			}
			save_scope_as = target_country
			ruler = {
				save_scope_as = target_character
			}
		}
	}

	option = {
		name = flavor_mlo.1.a
		historical_option = yes
		hidden_effect = { set_variable = mlo_ambrosian_path }


		change_government_type = government_type:republic
		add_reform = government_reform:ambrosian_republic_reform

		add_republican_tradition = 10
		add_stability = stability_ultimate_penalty

		every_neighbor_country = {
			limit = {
				is_subject = no
				religion = religion:catholic
				government_type = government_type:monarchy
			}
			add_opinion = { target = root modifier = mlo_against_ambrosian }
		}

		trigger_event_silently = {
			id = ambrosian_republic_disaster.2
			days = { 20 40 }
		}
	}

	option = {
		name = flavor_mlo.1.b

		trigger = { exists = scope:target_country }

		set_new_ruler = scope:target_character

		custom_tooltip = {
			text = establish_union_with_target_country_tt
			set_variable = chose_ally_union
		}
	}
}

ambrosian_republic_disaster.20 = {
	type = country_event
	title = flavor_mlo.2.title
	desc = flavor_mlo.2.desc
	trigger = {
		republican_tradition < 75.00
	}
	image = "gfx/interface/illustrations/disaster/ambrosian_republic_disaster.dds"

	illustration_tags = {
        10 = angry
        10 = interior
    }

	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
	}

	option = {
		name = flavor_mlo.2.a
		add_republican_tradition = -10
		add_stability = stability_extreme_bonus
	}
	option = {
		name = flavor_mlo.2.b
		add_republican_tradition = 10
		add_stability = stability_extreme_penalty
	}
}


ambrosian_republic_disaster.31 = { #Province Demands Autonomy
	type = country_event
	title = {
		first_valid = {
			triggered_desc = {
				trigger = { exists = scope:target_province }
				desc = flavor_mlo.31.title
			}
			triggered_desc = {
				trigger = { always = yes }
				desc = flavor_mlo.31.title.fallback
			}
		}
	}
	desc = flavor_mlo.31.desc
	image = "gfx/interface/illustrations/disaster/ambrosian_republic_disaster.dds"

	trigger = {
		any_active_disaster = {
			disaster_type = disaster_type:ambrosian_republic_disaster
		}
		num_provinces >= 3
		any_province = {
			owner ?= root
			NOT = {
				any_location_in_province = {
					owner = root
					is_capital = yes
				}
			}
			NOT = {	has_variable = had_autonomy_concerns }
		}
	}

	illustration_tags = {
        10 = angry
        10 = interior
    }

	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:burghers_estate background = estate_type:burghers_estate }
		random_province = {
			limit = {
				owner = root
				NOT = {
					any_location_in_province = {
						owner = root
						is_capital = yes
					}
				}
				NOT = {	has_variable = had_autonomy_concerns }
			}
			save_scope_as = target_province
			set_variable = {
				name = had_autonomy_concerns
			}
		}
	}

	option = {
		name = flavor_mlo.31.a
		historical_option = yes

		custom_tooltip = mlo_every_province_scope_province_tt
		show_as_tooltip = {
			scope:target_province = {
				change_control = control_mild_penalty
				add_pop_satisfaction = pop_satisfaction_ultimate_penalty
			}
		}
		hidden_effect = {
			scope:target_province = {
				every_location_in_province = {
					change_control = control_mild_penalty
					every_pop = {
						limit = {
							owner = root
						}
						add_pop_satisfaction = pop_satisfaction_ultimate_penalty
					}
				}
			}
		}
	}

	option = {
		name = flavor_mlo.31.b

		custom_tooltip = mlo_every_province_scope_province_tt
		show_as_tooltip = {
			scope:target_province = {
				change_control = control_extreme_penalty
				add_pop_satisfaction = pop_satisfaction_extreme_penalty
			}
		}
		hidden_effect = {
			scope:target_province = {
				every_location_in_province = {
					change_control = control_extreme_penalty
					every_pop = {
						limit = {
							owner = root
						}
						add_pop_satisfaction = pop_satisfaction_ultimate_penalty
					}
				}
			}
		}
	}

	option = {
		name = flavor_mlo.31.c

		trigger = {
			ruler ?= {
				has_trait = strict
			}
		}

		custom_tooltip = mlo_every_province_scope_province_tt
		show_as_tooltip = {
			scope:target_province = {
				add_pop_satisfaction = pop_satisfaction_ultimate_penalty
			}
		}
		hidden_effect = {
			scope:target_province = {
				every_location_in_province = {
					every_pop = {
						limit = {
							owner = root
						}
						add_pop_satisfaction = pop_satisfaction_ultimate_penalty
					}
				}
			}
		}
	}
}
