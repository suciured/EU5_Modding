namespace = flavor_vlt

# Volterra expels the Allegretti and has Belforti put as signorias
flavor_vlt.1 = {
	type = country_event
	title = flavor_vlt.1.title
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {
					exists = scope:expelled_ruler
				}
				desc = flavor_vlt.1.desc_expel
			}
			triggered_desc = {
				trigger = {
					always = yes
				}
				desc = flavor_vlt.1.desc_signoria
			}
		}
	}
	historical_info = flavor_vlt.1.historical_info

	fire_only_once = yes
	dynamic_historical_event = {
		tag = VLT
		from = 1339.1.1
		to = 1342.1.1
		monthly_chance = 25
	}

	trigger = {
		OR = {
			NOT = { has_reform = government_reform:dynastic_signoria_reform }
			AND = {
				has_ruler = yes
				ruler = character:vlt_rainuccio_allegretti
				dynasty_exists = belforti_dynasty
				dynasty:belforti_dynasty = {
					any_character_in_dynasty = {
						is_alive = yes
						is_ruler = no
						is_female = no
						age_in_years >= 20
						owner = ROOT
					}
				}
			}
		}	
	}

	illustration_tags = {
        10 = angry
        10 = exterior
    }

	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:burghers_estate background = estate_type:burghers_estate }
		if = {
			limit = {
				has_ruler = yes
				ruler = character:vlt_rainuccio_allegretti
				dynasty_exists = belforti_dynasty
				dynasty:belforti_dynasty = {
					any_character_in_dynasty = {
						is_alive = yes
						is_ruler = no
						is_female = no
						age_in_years >= 20
						owner = ROOT
					}
				}
				any_neighbor_country = {
					count >= 1
				}
			}
			ruler = {
				save_scope_as = expelled_ruler
			}
			dynasty:belforti_dynasty = {
				random_character_in_dynasty = {
					limit = {
						is_alive = yes
						is_ruler = no
						is_female = no
						age_in_years >= 20
						owner = ROOT
					}
					save_scope_as = belforti_candidate
				}
			}
			if = {
				limit = {
					character:vlt_ottaviano_belforti = {
						is_alive = yes
						is_ruler = no
						age_in_years >= 20
						owner = ROOT
					}
				}
				character:vlt_ottaviano_belforti = { save_scope_as = belforti_candidate }
			}
			random_neighbor_country = {
				save_scope_as = country_of_destination
			}
		}
	}

	option = {
		name = flavor_vlt.1.a 
		
		historical_option = yes
		
		if = {
			limit = {
				exists = scope:expelled_ruler
			}
			set_new_ruler = scope:belforti_candidate

			scope:expelled_ruler = {
				move_country = scope:country_of_destination
				every_descendant = {
					move_country = scope:country_of_destination
				}
			}
		}

		if = {
			limit = {
				NOT = { has_reform = government_reform:dynastic_signoria_reform }
			}
			add_reform = government_reform:dynastic_signoria_reform
			change_societal_value = {
				type = centralization_vs_decentralization 
				value = societal_value_large_move_to_left
			}
		}
	}

	option = {
		name = flavor_vlt.1.b
		
		add_republican_tradition = republican_tradition_severe_bonus
		add_stability = stability_mild_bonus
	}
}

# Belforti try to sell the country off
flavor_vlt.2 = {
	type = country_event
	title = flavor_vlt.2.title
	desc = flavor_vlt.2.desc
	historical_info = flavor_vlt.2.historical_info

	fire_only_once = yes
	dynamic_historical_event = {
		tag = VLT
		from = 1355.1.1
		to = 1365.1.1
		monthly_chance = 5
	}

	trigger = {
		has_ruler = yes
		ruler.dynasty ?= dynasty:belforti_dynasty
		country_exists = c:FLO
	}

	illustration_tags = {
        10 = armed
        10 = exterior
    }

	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:peasants_estate background = estate_type:peasants_estate }
		ruler = {
			save_scope_as = target_character
		}
		save_scope_as = target_country
	}

	option = {
		name = flavor_vlt.2.a 
		
		historical_option = yes
		
		kill_character = scope:target_character
		c:FLO = {
			trigger_event_non_silently = flavor_vlt.3
		}
	}
	
	option = {
		name = flavor_vlt.2.b 
		
		add_estate_satisfaction = {
			type = estate_type:nobles_estate
			value = estate_satisfaction_severe_penalty
		}
		add_estate_satisfaction = {
			type = estate_type:clergy_estate
			value = estate_satisfaction_severe_penalty
		}
		add_estate_satisfaction = {
			type = estate_type:burghers_estate
			value = estate_satisfaction_severe_penalty
		}
		add_estate_satisfaction = {
			type = estate_type:peasants_estate
			value = estate_satisfaction_severe_penalty
		}
		c:LUC ?= {
			trigger_event_non_silently = flavor_vlt.3
		}
	}
}

# Intervention
flavor_vlt.3 = {
	type = country_event
	title = flavor_vlt.3.title
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {
					scope:target_character = {
						is_alive = no
					}
				}
				desc = flavor_vlt.3.desc_consul_dead
			}
			triggered_desc = {
				trigger = {
				}
				desc = flavor_vlt.3.desc
			}
		}
	} 

	illustration_tags = {
        10 = armed
        10 = exterior
    }

	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:peasants_estate background = estate_type:peasants_estate }
	}
	
	option = {
		name = flavor_vlt.3.a

		add_casus_belli = {
			type = casus_belli:cb_annex
			target = scope:target_country
		}
	}
}