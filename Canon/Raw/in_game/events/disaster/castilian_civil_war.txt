namespace = castilian_civil_war

########################
# Disaster start event #
########################
scripted_effect ccw_side_against_ruler = {
	custom_tooltip = {
		text = ccw_side_against_ruler.$target$
		if = {
			limit = { list_size = { name = revolt_provinces_list value > 0 } }
			ordered_in_list = {
				list = revolt_provinces_list
				order_by = population
				max = {
					value = var:total_num_prov_variable
					divide = 6
					ceiling = yes
				}
				every_location_in_province = {
					every_pop = {
						limit = {
							owner = root
						}
						add_pop_satisfaction = pop_satisfaction_ultimate_penalty
						change_pop_allegiance = scope:succession_crisis_pretender_scope
					}
				}
			}
		}
		set_variable = {
			name = ccw_pretender_character
			value = scope:$target$
		}
	}
	add_stability = stability_extreme_penalty
	scope:$target$ = {
		add_character_modifier = { 
			modifier = plotting_rebellion_modifier
			years = -1
			mode = add_and_extend 
		}
		set_variable = {
			name = scope_pretender_var
			value = yes
		}
		change_character_allegiance = scope:succession_crisis_pretender_scope
	}
	create_gui_variable = {
		type = pretender_rebel_character
		target = scope:$target$
	}
}

scripted_effect ccw_clear_variables = {
	remove_variable = ccw_murder_at_court_counter
	remove_variable = ccw_timer
	remove_variable = ccw_has_reached_out_to_france_and_england
	remove_variable = ccw_has_reached_out_to_aragon_and_portugal
	remove_variable = ccw_had_mother_event
	remove_variable = ccw_had_iberian_ally_event
	remove_variable = ccw_had_100yw_ally_event
	remove_variable = ccw_ruler_character
	remove_variable = ccw_pretender_character
	remove_variable = ccw_legitimate_ruler_var
	remove_variable = ccw_bastard_ruler_var
	#Clear Lists
	clear_global_variable_list = ccw_loyalists_side
	clear_global_variable_list = ccw_rebels_side
}

scripted_effect ccw_set_ruler_pretender_scopes = {
	if = {
		limit = { has_variable = ccw_ruler_character }
		var:ccw_ruler_character = { save_scope_as = target_ruler }
	}
	if = {
		limit = { has_variable = ccw_pretender_character }
		var:ccw_pretender_character = { save_scope_as = target_pretender }
	}
}

scripted_effect ccw_set_legitimate_bastard_scopes = {
	if = {
		limit = { has_variable = ccw_legitimate_ruler_var }
		var:ccw_legitimate_ruler_var = { save_scope_as = target_legitimate }
	}
	if = {
		limit = { has_variable = ccw_bastard_ruler_var }
		var:ccw_bastard_ruler_var = { save_scope_as = target_bastard }
	}
}

scripted_effect ccw_select_preferred_pop_type = {
	if = {
		limit = { has_variable = ccw_sided_with_legal_heir }
		estate_type:nobles_estate = { save_scope_as = target_estate }
	}
	else_if = {
		limit = { has_variable = ccw_sided_with_bastard_heir }
		estate_type:burghers_estate = { save_scope_as = target_estate }
	}
}

scripted_effect ccw_set_rebels_scope = {
	if = {
		limit = { has_variable = succession_crisis_pretender_variable }
		var:succession_crisis_pretender_variable = { save_scope_as = target_rebels }
	}
}

scripted_effect ccw_set_promised_basque_land_scopes = {
	province_definition:biscay_province = { save_scope_as = target_province_definition }
	location:calahorra = { save_scope_as = target_location_1 }
	location:logrono = { save_scope_as = target_location_2 }
}

scripted_effect ccw_seize_location = {
	if = {
		limit = { $location$ = { owner = $owner$ } }
		$location$ = { change_location_owner = $target$ }
	}
	else = {
		$owner$ = { add_gold = { value = $owner$.monthly_income_trade_and_tax multiply = -1 } }
		$target$ = { add_gold = { value = $owner$.monthly_income_trade_and_tax } }
	}
}

scripted_effect ccw_grant_reward_for_joining_side_eng_fra = {
	$target$ = { add_opinion = { target = $from$ modifier = opinion_historical_friend_CAS_ccw } }
	$from$ = { add_opinion = { target = $target$ modifier = opinion_historical_friend_CAS_ccw } }
	ccw_seize_location = { location = scope:target_location_3 owner = $from$ target = $target$ }
	ccw_seize_location = { location = scope:target_location_6 owner = $from$ target = $target$ }
	ccw_seize_location = { location = scope:target_location_8 owner = $from$ target = $target$ }
	create_alliance = { target = $from$ }
	if = {
		limit = { is_situation_active = situation:hundred_years_war }
		custom_tooltip = ccw_from_country_joins_target_country_in_100yw_issues_tt
	}
	set_variable = {
		name = ccw_pretender_promises_100yw_support
		value = $from$
	}
}

scripted_effect ccw_grant_reward_for_joining_side_nav = {
	$target$ = { add_opinion = { target = $from$ modifier = opinion_historical_friend_CAS_ccw } }
	$from$ = { add_opinion = { target = $target$ modifier = opinion_historical_friend_CAS_ccw } }
	#Seize Basque lands to the ally in question
	ccw_seize_location = { location = scope:target_location_1 owner = $from$ target = $target$ }
	ccw_seize_location = { location = scope:target_location_2 owner = $from$ target = $target$ }
	#ccw_seize_location = { location = scope:target_location_3 owner = $from$ target = $target$ }	#They go to their 100yw ally
	ccw_seize_location = { location = scope:target_location_4 owner = $from$ target = $target$ }
	ccw_seize_location = { location = scope:target_location_5 owner = $from$ target = $target$ }
	#ccw_seize_location = { location = scope:target_location_6 owner = $from$ target = $target$ }	#They go to their 100yw ally
	ccw_seize_location = { location = scope:target_location_7 owner = $from$ target = $target$ }
	#ccw_seize_location = { location = scope:target_location_8 owner = $from$ target = $target$ }	#They go to their 100yw ally
}

scripted_effect ccw_grant_reward_for_joining_side_por = {
	$target$ = { add_opinion = { target = $from$ modifier = opinion_historical_friend_CAS_ccw } }
	$from$ = { add_opinion = { target = $target$ modifier = opinion_historical_friend_CAS_ccw } }
	#Alliance
	create_alliance = { target = $from$ }
	#Cash out
	$from$ = { add_gold = { value = $from$.monthly_income_trade_and_tax multiply = -9 } }
	$target$ = { add_gold = { value = $from$.monthly_income_trade_and_tax multiply = 9 } }
}

scripted_effect ccw_grant_reward_for_joining_side_ara = {
	$target$ = { add_opinion = { target = $from$ modifier = opinion_historical_friend_CAS_ccw } }
	$from$ = { add_opinion = { target = $target$ modifier = opinion_historical_friend_CAS_ccw } }
	#Alliance
	create_alliance = { target = $from$ }
	#Province
	scope:target_province_definition = {
		every_location_in_province_definition = {
			ccw_seize_location = { location = this owner = $from$ target = $target$ }
		}
	}
}

scripted_effect ccw_grant_reward_for_joining_side_other = {
	$target$ = { add_opinion = { target = $from$ modifier = opinion_historical_friend_CAS_ccw } }
	$from$ = { add_opinion = { target = $target$ modifier = opinion_historical_friend_CAS_ccw } }
	#Cash out
	$from$ = { add_gold = { value = $from$.monthly_income_trade_and_tax multiply = -24 } }
	$target$ = { add_gold = { value = $from$.monthly_income_trade_and_tax multiply = 24 } }
}

#Only really used for tooltipping... the scopes are getting a bit confused during the real events.
scripted_effect ccw_grant_reward_for_joining_side = {
	if = {
		limit = { OR = { tag = ENG culture = culture:english tag = FRA culture = culture:french } }
		ccw_grant_reward_for_joining_side_eng_fra = { from = scope:from_country target = scope:target_country }
	}
	else_if = {
		limit = { tag = NAV }
		ccw_grant_reward_for_joining_side_nav = { from = scope:from_country target = c:NAV }
	}
	else_if = {
		limit = { OR = { tag = POR culture = culture:portuguese } }
		ccw_grant_reward_for_joining_side_por = { from = scope:from_country target = scope:target_country }
	}
	else_if = {
		limit = { OR = { tag = ARA culture = culture:catalan culture = culture:aragonese } }
		ccw_grant_reward_for_joining_side_ara = { from = scope:from_country target = scope:target_country }
	}
	else = {
		ccw_grant_reward_for_joining_side_other = { from = scope:from_country target = scope:target_country }
	}
}

scripted_effect ccw_grant_reward_for_getting_demands_rejected = {
	#Opinion Bonus
	scope:target_country = { add_opinion = { target = scope:from_country modifier = opinion_historical_rival_CAS_ccw } break_alliance = { target = scope:from_country } }
	scope:from_country = { add_opinion = { target = scope:target_country modifier = opinion_historical_rival_target_ccw } }
	if = {
		limit = { scope:target_country = { OR = { tag = ENG culture = culture:english tag = FRA culture = culture:french } } }
		scope:target_country = {
			add_casus_belli = {	
				target = scope:from_country
				type = casus_belli:cb_conquer_province
				province = scope:target_location_3.province
			}
			add_casus_belli = {
				target = scope:from_country
				type = casus_belli:cb_conquer_province
				province = scope:target_location_8.province
			}
		}
	}
	else_if = {
		limit = { scope:target_country = { tag = NAV } }
		scope:target_country = {
			add_casus_belli = {	
				target = scope:from_country
				type = casus_belli:cb_conquer_province
				province = scope:target_location_3.province
			}
			add_casus_belli = {
				target = scope:from_country
				type = casus_belli:cb_conquer_province
				province = scope:target_location_1.province
			}
			add_casus_belli = {
				target = scope:from_country
				type = casus_belli:cb_conquer_province
				province = scope:target_location_2.province
			}
			add_casus_belli = {
				target = scope:from_country
				type = casus_belli:cb_conquer_province
				province = scope:target_location_8.province
			}
		}
	}
	else_if = {
		limit = { scope:target_country = { OR = { tag = POR culture = culture:portuguese } } }
		scope:target_country = {
			add_casus_belli = {
				target = scope:from_country
				type = casus_belli:cb_claim_throne
			}
		}
	}
	else_if = {
		limit = { scope:target_country = { OR = { tag = ARA culture = culture:catalan culture = culture:aragonese } } }
		scope:target_country = {
			add_casus_belli = {
				target = scope:from_country
				type = casus_belli:cb_claim_throne
			}
		}
	}
	else = {	#Fallback
		scope:target_country = {
			add_casus_belli = {
				target = scope:from_country
				type = casus_belli:cb_insulted_us
			}
		}
	}
}

scripted_effect ccw_show_reward_for_joining_side = {
	custom_tooltip = castilian_civil_war.$side$_join_reward
	show_as_tooltip = {
		ccw_grant_reward_for_joining_side = yes
	}
}

scripted_effect ccw_show_reward_for_joining_side_for_root = {
	custom_tooltip = castilian_civil_war.$side$_join_reward_for_root
	show_as_tooltip = {
		ccw_grant_reward_for_joining_side = yes
	}
}
scripted_effect ccw_setup_rewards_for_joining_side = {
	#Basque lands
	location:calahorra = { 	save_scope_as = target_location_1 }
	location:logrono = { 	save_scope_as = target_location_2 }
	location:bilbao = { 	save_scope_as = target_location_3 }
	location:laguardia = { 	save_scope_as = target_location_4 }
	location:san_sebastian = { 	save_scope_as = target_location_5 }
	location:valmaseda = { 	save_scope_as = target_location_6 }
	location:vitoria = { 	save_scope_as = target_location_7 }
	location:laredo = { 	save_scope_as = target_location_8 }
	#British / French lands promised
	#bilbao valmaseda laredo
	#Random neighboring province for Aragon
	province_definition:murcia_province = {
		save_scope_as = target_province_definition
	}
}

scripted_effect ccw_add_to_list = {
	hidden_effect = {
		add_to_global_variable_list = { name = ccw_$side$_side target = $target$ }
	}
}

scripted_effect ccw_joins_ruler_side_effect = {
	custom_tooltip = castilian_civil_war.1031.a.tt.join_war
	#100 Years War promise
	if = {
		limit = {
			is_situation_active = situation:hundred_years_war
			OR = {
				tag = ENG
				tag = FRA
			}
		}
		custom_tooltip = {
			text = castilian_civil_war.1031.a.tt.100yw
			if = {
				limit = {
					country_exists = c:NAV
					c:NAV = {
						is_allied_with = { target = scope:target_country }
					}
				}
				scope:from_country = { trigger_event_silently = castilian_civil_war.1035 }
			}
		}
	}
	ccw_add_to_list = { side = loyalists target = scope:target_country } 
	#Promises from the ruler
	ccw_show_reward_for_joining_side = { side = loyalists }
}

scripted_effect ccw_support_war_side_not_war_join_effect_mercs = {
	capital = { save_scope_as = capital_scope }
	if = {
		limit = {
			OR = {
				tag = ARA
				culture = culture:aragonese
				culture = culture:catalan
			}
		}
		create_mercenary = {
			name = ccw_ara_company
			home = scope:capital_scope
			borrower = $target$
			categories = {
				army_infantry = 7
			}
			save_scope_as = ccw_condotieri
		}
	}
	if = {
		limit = {
			OR = {
				tag = POR
				culture = culture:portuguese
			}
		}
		create_mercenary = {
			name = ccw_por_company
			home = scope:capital_scope
			borrower = $target$
			categories = {
				army_infantry = 7
			}
			save_scope_as = ccw_condotieri
		}
	}
	if = {
		limit = {
			OR = {
				tag = FRA
				culture = culture:french
			}
		}
		create_mercenary = {
			name = ccw_fra_company
			home = scope:capital_scope
			borrower = $target$
			categories = {
				army_infantry = 7
			}
			save_scope_as = ccw_condotieri
		}
	}
	if = {
		limit = {
			OR = {
				tag = ENG
				culture = culture:english
			}
		}
		create_mercenary = {
			name = ccw_eng_company
			home = scope:capital_scope
			borrower = $target$
			categories = {
				army_infantry = 7
			}
			save_scope_as = ccw_condotieri
		}
	}
	if = {
		limit = {
			OR = {
				tag = NAV
				culture = culture:basque
			}
		}
		create_mercenary = {
			name = ccw_nav_company
			home = scope:capital_scope
			borrower = $target$
			categories = {
				army_infantry = 7
			}
			save_scope_as = ccw_condotieri
		}
	}
	if = {
		limit = {
			NOR = {
				tag = ARA
				culture = culture:aragonese
				culture = culture:catalan
				tag = POR
				culture = culture:portuguese
				tag = FRA
				culture = culture:french
				tag = ENG
				culture = culture:english
				tag = NAV
				culture = culture:basque
			}
		}
		create_mercenary = {
			name = ccw_nav_company
			home = scope:capital_scope
			borrower = $target$
			categories = {
				army_infantry = 7
			}
			save_scope_as = ccw_condotieri
		}
	}
	$target$ = {
		if = {
			limit = { exists = scope:ccw_condotieri }
			hire_mercenary = scope:ccw_condotieri
		}
		custom_tooltip = ccw_hire_mercs_tt
	}
}
scripted_effect ccw_support_war_side_not_war_join_effect_gold = {
	transfer_yearly_gold = {
		value = 3
		target = $target$
	}
}
scripted_effect ccw_support_war_side_not_war_join_effect = {
	ccw_support_war_side_not_war_join_effect_$type$ = { target = $target$ }
}

castilian_civil_war.1 = {
	image = "gfx/interface/illustrations/disaster/castilian_civil_war.dds"
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1.title
	desc = castilian_civil_war.1.desc

	immediate = {
		
		save_scope_as = target_country
		set_variable = {
			name = ccw_active
			value = 0.05
		}
		set_variable = { name = choosing_new_pretender days = 40 }
		create_rebel = {
			category = pretender
			name = succession_crisis_pretender
			save_scope_as = succession_crisis_pretender_scope
		}
		set_variable = {
			name = succession_crisis_pretender_variable
			value = scope:succession_crisis_pretender_scope
		}
		if = {
			limit = { has_variable = ccw_ruler_target }
			remove_variable = ccw_ruler_target
			ruler = { save_scope_as = ccw_legitimate_ruler }
		}
		if = {
			limit = { has_variable = ccw_heir_target }
			remove_variable = ccw_heir_target
			heir = { save_scope_as = ccw_legitimate_ruler }
		}
		if = {
			limit = {
				exists = character:cas_enrique_ii_trastamara
				character:cas_enrique_ii_trastamara = { is_alive = yes }
			}
			character:cas_enrique_ii_trastamara = { save_scope_as = ccw_bastard_ruler }
		}
		else = {
			ordered_character = {
				order_by = total_abilities
				limit = {
					is_alive = yes
					father = character:cas_alfonso_xi_burgundy
					mother = character:cas_leonor_guzman
					OR = {
						is_eligible_heir = root
						AND = {
							has_character_modifier = bastard
							is_legally_male = yes
							is_adult = yes
						}
					}
				}
				max = 1
				check_range_bounds = no
				save_scope_as = ccw_bastard_ruler
			}
		}
		character:cas_alfonso_xi_burgundy = { save_scope_as = previous_ruler }
		set_variable = {
			name = ccw_legitimate_ruler_var
			value = scope:ccw_legitimate_ruler
		}
		set_variable = {
			name = ccw_bastard_ruler_var
			value = scope:ccw_bastard_ruler
		}
		set_variable = {
			name = total_num_prov_variable
			value = 0
		}
		set_variable = {
			name = ccw_timer	#Once this timer runs out, the pretender rebel character will seek allies
			value = yes
			days = 730
		}
		set_variable = {
			name = ccw_allies_timer	#Once this timer runs out, the crown will seek allies
			value = yes
			days = 730
		}
		every_province = {
			limit = {
				OR = {
					province_average_control < 0.5
					province_food_percentage < 0.5
					province_satisfaction < 0.5
				}
				any_location_in_province = { is_capital = no }
			}
			add_to_list = revolt_provinces_list
			owner = {
				change_variable = { 
					name = total_num_prov_variable 
					add = 1 
				}
			}
		}
	}

	#Side with the legal ruler
	option = {
		name = castilian_civil_war.1.a
		historical_option = yes
		ccw_side_against_ruler = { target = ccw_bastard_ruler }
		add_estate_satisfaction = { type = estate_type:nobles_estate value = estate_satisfaction_severe_penalty }
		custom_tooltip = {
			text = castilian_civil_war.1.nobility_joins_bastard
			if = {
				limit = { list_size = { name = revolt_provinces_list value > 0 } }
				ordered_in_list = {
					list = revolt_provinces_list
					order_by = population
					max = {
						value = var:total_num_prov_variable
						divide = 3
						ceiling = yes
					}
					every_location_in_province = {
						every_pop = {
							limit = {
								owner = root
								pop_type = pop_type:nobles
							}
							add_pop_satisfaction = pop_satisfaction_ultimate_penalty
							change_pop_allegiance = scope:succession_crisis_pretender_scope
						}
					}
				}
			}
			set_variable = {
				name = ccw_ruler_character
				value = scope:ccw_legitimate_ruler
			}
			set_variable = {
				name = ccw_sided_with_legal_heir
				value = yes
			}
			if = {
				limit = {
					character:cas_leonor_guzman = {
						is_alive = yes
						owner = root
					}
				}
				character:cas_leonor_guzman = {
					add_character_modifier = {
						modifier = plotting_rebellion_modifier
						mode = add_and_extend
						years = -1
					}
				}
			}
			every_character = {
				limit = {
					father ?= character:cas_alfonso_xi_burgundy
					mother ?= character:cas_leonor_guzman
				}
				add_character_modifier = {
					modifier = plotting_rebellion_modifier
					mode = add_and_extend
					years = -1
				}
			}
			every_character = {
				limit = {
					father ?= character:cas_alfonso_xi_burgundy
					mother ?= character:cas_maria_portugal
				}
				add_character_modifier = {
					modifier = ccw_ruler_siblings
					mode = add_and_extend
					years = -1
				}
			}
		}
	}
	#Side with the bastard ruler
	option = {
		name = castilian_civil_war.1.b
		hidden_effect = { scope:ccw_bastard_ruler = { remove_variable = scope_pretender_var } }	#no longer a pretender
		set_new_ruler = scope:ccw_bastard_ruler
		ccw_side_against_ruler = { target = ccw_legitimate_ruler }
		add_estate_satisfaction = { type = estate_type:nobles_estate value = estate_satisfaction_mild_bonus }
		add_estate_satisfaction = { type = estate_type:burghers_estate value = estate_satisfaction_mild_penalty }
		add_estate_satisfaction = { type = estate_type:peasants_estate value = estate_satisfaction_mild_penalty }
		custom_tooltip = {
			text = castilian_civil_war.1.commoners_join_legitimate_ruler
			if = {
				limit = { list_size = { name = revolt_provinces_list value > 0 } }
				ordered_in_list = {
					list = revolt_provinces_list
					order_by = population
					max = {
						value = var:total_num_prov_variable
						divide = 3
						ceiling = yes
					}
					every_location_in_province = {
						every_pop = {
							limit = {
								owner = root
								OR = {
									pop_type = pop_type:peasants
									pop_type = pop_type:burghers
								}
							}
							add_pop_satisfaction = pop_satisfaction_ultimate_penalty
							change_pop_allegiance = scope:succession_crisis_pretender_scope
						}
					}
				}
			}
			set_variable = {
				name = ccw_ruler_character
				value = scope:ccw_bastard_ruler
			}
			set_variable = {
				name = ccw_sided_with_bastard_heir
				value = yes
			}
			if = {
				limit = {
					character:cas_maria_portugal = {
						is_alive = yes
						owner = root
					}
				}
				character:cas_maria_portugal = {
					add_character_modifier = {
						modifier = plotting_rebellion_modifier
						mode = add_and_extend
						years = -1
					}
				}
			}
			every_character = {
				limit = {
					exists = father
					exists = mother
					father = character:cas_alfonso_xi_burgundy
					mother = character:cas_maria_portugal
				}
				add_character_modifier = {
					modifier = plotting_rebellion_modifier
					mode = add_and_extend
					years = -1
				}
			}
			every_character = {
				limit = {
					exists = father
					exists = mother
					father = character:cas_alfonso_xi_burgundy
					mother = character:cas_leonor_guzman
				}
				add_character_modifier = {
					modifier = ccw_ruler_siblings
					mode = add_and_extend
					years = -1
				}
				if = {
					limit = { has_character_modifier = bastard }
					remove_character_modifier = bastard
				}
			}
		}
	}
	after = {
		remove_variable = total_num_prov_variable
	}
}

#############################
# Disaster repeating events #
#############################
#Province acknowledges Pretender Rebels
castilian_civil_war.2 = {
	type = country_event
	category = disaster_event
	title = {
		first_valid = {
			triggered_desc = {
				trigger = {
					exists = scope:target_province
					exists = scope:target_rebels
				}
				desc = castilian_civil_war.2.title
			}
			triggered_desc = {
				trigger = { always = yes }
				desc = castilian_civil_war.2.title.fallback
			}
		}
	}
	desc = castilian_civil_war.2.desc
	illustration_tags = {
		10 = armed
		10 = exterior
	}
	trigger = {
		has_variable = succession_crisis_pretender_variable
		var:succession_crisis_pretender_variable = {
			rebel_progress < 1
		}
		region:iberia_region = {
			any_area_in_region = {
				any_province_in_area = {
					province_average_control < 0.5
					NOT = { has_province_modifier = ccw_sided_with_crown }
					NOT = { has_province_modifier = ccw_sided_with_pretender }
					any_location_in_province = {
						owner = root
						controller = root
						is_capital = no
						count = all
					}
				}
			}
		}
	}
	immediate = {
		if = {
			limit = { has_variable = ccw_sided_with_legal_heir }
			event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		}
		else = {
			event_illustration_estate_effect = { foreground = estate_type:burghers_estate background = estate_type:burghers_estate }
		}
		ccw_set_ruler_pretender_scopes = yes
		ccw_select_preferred_pop_type = yes
		var:succession_crisis_pretender_variable = {
			save_scope_as = target_rebels
		}
		region:iberia_region = {
			random_area_in_region = {
				limit = {	#Yes, the limit is checked TWICE to make sure the game actually realizes that I want a) the area with a fitting province and b) the fitting province in the aforementioned area..
					any_province_in_area = {
						province_average_control < 0.5
						NOT = { has_province_modifier = ccw_sided_with_crown }
						NOT = { has_province_modifier = ccw_sided_with_pretender }
						any_location_in_province = {
							owner = root
							controller = root
							is_capital = no
							count = all
						}
					}
				}
				random_province_in_area = {
					limit = {
						province_average_control < 0.5
						NOT = { has_province_modifier = ccw_sided_with_crown }
						NOT = { has_province_modifier = ccw_sided_with_pretender }
						any_location_in_province = {
							owner = root
							controller = root
							is_capital = no
							count = all
						}
					}
					save_scope_as = target_province
				}
			}
		}
	}
	#Province is persuaded to stick to the crown
	option = {
		name = castilian_civil_war.2.a
		change_gold_effect = { scale = -3 }
		scope:target_province = {
			add_province_modifier = {
				modifier = ccw_sided_with_crown
				years = 20
				mode = add_and_extend
			}
		}
	}
	#Province changes loyalty to the pretender
	option = {
		name = castilian_civil_war.2.b
		scope:target_province = {
			if = {
				limit = { ROOT = { has_variable = ccw_sided_with_legal_heir } }
				custom_tooltip = castilian_civil_war.2.b.at
			}
			else = {
				custom_tooltip = castilian_civil_war.2.b.bt
			}
			hidden_effect = {
				every_location_in_province = {
					limit = {
						owner = root
						controller = root
					}
					every_pop = {
						limit = {
							owner = root
							OR = {
								AND = {
									ROOT = { has_variable = ccw_sided_with_legal_heir }
									pop_type = pop_type:burghers
								}
								AND = {
									ROOT = { has_variable = ccw_sided_with_bastard_heir }
									pop_type = pop_type:nobles
								}
								pop_type = pop_type:peasants
							}
						}
						change_pop_allegiance = scope:target_rebels
						add_pop_satisfaction = pop_satisfaction_ultimate_penalty
					}
				}
			}
			add_province_modifier = {
				modifier = ccw_sided_with_pretender
				years = 20
				mode = add_and_extend
			}
		}
	}
}

#Estate Supports Rebellion
castilian_civil_war.3 = {
	hide_portraits = yes
	type = country_event
	category = disaster_event
	title = {
		first_valid = {
			triggered_desc = {
				trigger = { exists = scope:target_estate }
				desc = castilian_civil_war.3.title
			}
			triggered_desc = {
				trigger = { always = yes }
				desc = castilian_civil_war.3.title.fallback
			}
		}
	}
	desc = castilian_civil_war.3.desc
	illustration_tags = {
		10 = armed
		10 = exterior
	}
	trigger = {
		has_variable = succession_crisis_pretender_variable
		var:succession_crisis_pretender_variable = {
			rebel_progress < 1
		}
		OR = {
			capital = {
				province = {
					NOT = { has_province_modifier = ccw_disloyal_burghers }
					NOT = { has_province_modifier = ccw_disloyal_nobles }
				}
			}
			AND = {
				has_variable = ccw_sided_with_legal_heir
				estate_satisfaction:nobles_estate < 0.4
				num_possible_estate_privileges:nobles_estate > 0
			}
			AND = {
				has_variable = ccw_sided_with_bastard_heir
				estate_satisfaction:burghers_estate < 0.4
				num_possible_estate_privileges:burghers_estate > 0
			}
		}
	}
	immediate = {
		switch = {
			trigger = has_variable
			ccw_sided_with_legal_heir = {
				event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
				
				"estate(estate_type:nobles_estate)" = {
					random_possible_privilege = {
						root = { grant_estate_privilege = prev }
					}
				}

				random_estate = {
					limit = { estate_type = estate_type:nobles_estate }
					save_scope_as = target_estate
				}
				"estate(estate_type:nobles_estate)" = {
					random_possible_privilege = {
						save_scope_as = target_privilege
					}
				}
			}
			ccw_sided_with_bastard_heir = {
				event_illustration_estate_effect = { foreground = estate_type:burghers_estate background = estate_type:burghers_estate }
				
								"estate(estate_type:nobles_estate)" = {
					random_possible_privilege = {
						root = { grant_estate_privilege = prev }
					}
				}
				
				random_estate = {
					limit = { estate_type = estate_type:burghers_estate }
					save_scope_as = target_estate
				}
				
				"estate(estate_type:burghers_estate)" = {
					random_possible_privilege = {
						save_scope_as = target_privilege
					}
				}
			}
		}
		ccw_set_ruler_pretender_scopes = yes
		var:succession_crisis_pretender_variable = {
			save_scope_as = target_rebels
		}
		capital = {
			province = {
				save_scope_as = target_province
			}
		}
	}
	#That is not a real issue
	option = {
		name = castilian_civil_war.3.a
		switch = {
			trigger = has_variable
			ccw_sided_with_legal_heir = {
				scope:target_province = {
					add_province_modifier = {
						modifier = ccw_disloyal_nobles
						years = 20
						mode = add_and_extend
					}
					every_location_in_province = {
						limit = { owner = root controller = root }
						every_pop = {
							limit = {
								owner = root
								pop_type = pop_type:nobles
							}
							add_pop_satisfaction = pop_satisfaction_radical_penalty
							change_pop_allegiance = scope:target_rebels
						}
					}
				}
				add_estate_satisfaction = { type = estate_type:nobles_estate value = estate_satisfaction_severe_penalty }
			}
			ccw_sided_with_bastard_heir = {
				scope:target_province = {
					add_province_modifier = {
						modifier = ccw_disloyal_burghers
						years = 20
						mode = add_and_extend
					}
					every_location_in_province = {
						limit = { owner = root controller = root }
						every_pop = {
							limit = {
								owner = root
								pop_type = pop_type:burghers
							}
							add_pop_satisfaction = pop_satisfaction_radical_penalty
							change_pop_allegiance = scope:target_rebels
						}
					}
				}
				add_estate_satisfaction = { type = estate_type:burghers_estate value = estate_satisfaction_severe_penalty }
			}
		}
		add_stability = stability_mild_penalty
	}
	#Bribe them with a new privilege
	option = {
		name = castilian_civil_war.3.b
		grant_estate_privilege = scope:target_privilege
		if = {
			limit = {
				scope:target_estate = { estate_type = estate_type:burghers_estate }
			}
			add_estate_satisfaction = { type = estate_type:burghers_estate value = estate_satisfaction_severe_bonus }
		}
		else = {
			add_estate_satisfaction = { type = estate_type:nobles_estate value = estate_satisfaction_severe_bonus }
		}
	}
	#Masacre the Traitors
	option = {
		name = castilian_civil_war.3.c
		trigger = {
			ruler ?= {
				OR = {
					has_character_modifier = erratic
					has_trait = cruel
					has_trait = malevolent
				}
			}
		}
		switch = {
			trigger = has_variable
			ccw_sided_with_legal_heir = {
				scope:target_province = {
					every_location_in_province = {
						limit = {
							owner = root
							controller = root
						}
						random_pop = {
							limit = { pop_type = pop_type:nobles }
							add_pop_size = {
								value = pop_size
								multiply = -0.33
							}
						}
					}
				}
			}
			ccw_sided_with_bastard_heir = {
				scope:target_province = {
					every_location_in_province = {
						limit = {
							owner = root
							controller = root
						}
						random_pop = {
							limit = { pop_type = pop_type:burghers }
							add_pop_size = {
								value = pop_size
								multiply = -0.33
							}
						}
					}
				}
			}
		}
	}
}

#######################
# Disaster end events #
#######################
castilian_civil_war.100 = {
	hide_portraits = yes
	type = country_event
	category = disaster_event
	title = {
		first_valid = {
			triggered_desc = {
				trigger = { in_civil_war = yes }
				desc = castilian_civil_war.100.title.war
			}
			triggered_desc = {
				trigger = { always = yes }
				desc = castilian_civil_war.100.title
			}
		}
	}
	illustration_tags = {
		10 = armed
		10 = exterior
	}
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {	in_civil_war = yes }
				desc = castilian_civil_war.100.desc.war
			}
			triggered_desc = {
				trigger = {
					has_variable = pretender_given_throne_variable
					scope:target_ruler = { is_alive = yes }
				}
				desc = castilian_civil_war.100.desc.inheritance
			}
			triggered_desc = {
				trigger = {
					has_variable = pretender_given_throne_variable
					scope:target_ruler = { is_alive = no }
				}
				desc = castilian_civil_war.100.desc.ruler_death
			}
			triggered_desc = {
				trigger = {
					NOT = { any_character = { has_variable = scope_pretender_var } }
					in_civil_war = no
				}
				desc = castilian_civil_war.100.desc.pretender_death
			}
			triggered_desc = { 
				desc = castilian_civil_war.100.desc.fallback
			}
		}
	}
	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		ccw_set_ruler_pretender_scopes = yes
		set_character_siblings_scope = { first_sibling = scope:target_ruler second_sibling = scope:target_pretender }
		save_scope_as = from_country
		if = {
			limit = { in_civil_war = yes }
			random_current_war = {
				limit = { is_civil_war_for = scope:from_country }
				save_scope_as = target_war
				random_attacker = {
					save_scope_as = target_rebel_country
				}
			}
		}
		every_character = {
			limit = { has_character_modifier = ccw_ruler_siblings }
			remove_character_modifier = ccw_ruler_siblings
		}
	}

	#A bloody war is ahead of us... (Civil War has started option)
	option = {
		name = castilian_civil_war.100.war
		trigger = { in_civil_war = yes }
		add_stability = stability_mild_bonus
		add_legitimacy = legitimacy_mild_bonus
		every_in_global_list = {
			variable = ccw_loyalists_side
			if = {
				limit = {
					country_exists = this
					#NOT = { in_union_with = scope:from_country }
					#is_subject = no
					NOT = { is_at_war_with = scope:from_country }
				}
				trigger_event_non_silently = castilian_civil_war.200
			}
		}
		every_in_global_list = {
			variable = ccw_rebels_side
			if = {
				limit = {
					country_exists = this
					NOT = { in_union_with = scope:from_country }
					is_subject = no
					NOT = { is_at_war_with = scope:from_country }
				}
				trigger_event_non_silently = castilian_civil_war.300
			}
		}
		set_variable = ccw_proper_civil_war_active
		if = {
			limit = { exists = scope:target_rebel_country }
			scope:target_rebel_country = {
				set_variable = ccw_proper_civil_war_active
				set_variable = ccw_is_rebel_country
				if = {
					limit = {
						exists = scope:target_pretender
						scope:target_pretender = {
							is_alive = yes
						}
					}
					set_new_ruler = scope:target_pretender
				}
			}
		}
	}

	option = {
		name = castilian_civil_war.100.peace
		trigger = { in_civil_war = no }		
		add_legitimacy = {
			value = "estate_power(estate_type:crown_estate)"
			add = 5
			multiply = 3
			min = 15
		}
		add_stability = {
			value = root.prestige
			add = 5
			min = 15
		}
		every_in_global_list = {
			variable = ccw_loyalists_side
			trigger_event_non_silently = castilian_civil_war.101
		}
		every_in_global_list = {
			variable = ccw_rebels_side
			trigger_event_non_silently = castilian_civil_war.101
		}
	}
}
#No Civil War
castilian_civil_war.101 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.100.title
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {
					scope:from_country = {
						has_variable = pretender_given_throne_variable
						scope:target_ruler = { is_alive = yes }
					}
				}
				desc = castilian_civil_war.100.desc.inheritance
			}
			triggered_desc = {
				trigger = {
					scope:from_country = {
						has_variable = pretender_given_throne_variable
						scope:target_ruler = { is_alive = no }
					}
				}
				desc = castilian_civil_war.100.desc.ruler_death
			}
			triggered_desc = {
				trigger = {
					scope:from_country = {
						NOT = { any_character = { has_variable = scope_pretender_var } }
						in_civil_war = no
					}
				}
				desc = castilian_civil_war.100.desc.pretender_death
			}
			triggered_desc = { 
				desc = castilian_civil_war.100.desc.fallback
			}
		}
	}
	illustration_tags = {
		10 = regular
		10 = exterior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	#What about our deals?
	option = {
		name = castilian_civil_war.101.a
		custom_tooltip = castilian_civil_war.101.a.tt
	}
}

#Loyalists can join Castile
castilian_civil_war.200 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.100.title.war
	desc = castilian_civil_war.100.desc.war
	illustration_tags = {
		10 = armed
		10 = exterior
	}
	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		save_scope_as = target_country
	}
	#The time is ripe to join into the fray!
	option = {
		name = castilian_civil_war.200.join_war
		trigger = {
			OR = {
				is_ai = no
				tag = POR
				tag = ARA
				culture = culture:portuguese
				culture = culture:aragonese
				culture = culture:catalan
			}
		}
		historical_option = yes
		show_as_tooltip = { join_war_as_defender = { war = scope:target_war call_in_subjects = yes } }
		set_variable = ccw_has_join_war
		set_variable = ccw_has_helped_in_war
		scope:from_country = { trigger_event_silently = castilian_civil_war.201 }
	}
	#The time is ripe to join into the fray!
	option = {
		name = castilian_civil_war.200.mercs
		show_as_tooltip = { ccw_support_war_side_not_war_join_effect = { type = mercs target = scope:from_country } }
		set_variable = ccw_has_mercs
		set_variable = ccw_has_helped_in_war
		scope:from_country = { trigger_event_silently = castilian_civil_war.201 }
	}
	#The time is ripe to join into the fray!
	option = {
		name = castilian_civil_war.200.gold
		show_as_tooltip = { ccw_support_war_side_not_war_join_effect = { type = gold target = scope:from_country } }
		set_variable = ccw_has_gold
		set_variable = ccw_has_helped_in_war
		scope:from_country = { trigger_event_silently = castilian_civil_war.201 }
	}
	#We cannot afford getting involved in their issues
	option = {
		name = castilian_civil_war.200.coward
		scope:from_country = { trigger_event_silently = castilian_civil_war.202 }
	}
}
#Loyalists join Castile
castilian_civil_war.201 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.201.title
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = { scope:target_country = { has_variable = ccw_has_join_war } }
				desc = castilian_civil_war.201.desc.join_war
			}
			triggered_desc = {
				trigger = { scope:target_country = { has_variable = ccw_has_mercs } }
				desc = castilian_civil_war.201.desc.mercs
			}
			triggered_desc = {
				trigger = { scope:target_country = { has_variable = ccw_has_gold } }
				desc = castilian_civil_war.201.desc.gold
			}
			triggered_desc = {
				desc = castilian_civil_war.201.desc
			}
		}
	}
	after = {
		scope:target_country = {
			if = { limit = { has_variable = ccw_has_join_war } 	remove_variable = ccw_has_join_war }
			if = { limit = { has_variable = ccw_has_mercs } 	remove_variable = ccw_has_mercs }
			if = { limit = { has_variable = ccw_has_gold } 		remove_variable = ccw_has_gold }
		}
	}
	illustration_tags = {
		10 = armed
		10 = exterior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	#At least we can count on their support
	option = {
		name = castilian_civil_war.201.a
		scope:target_country = {
			switch = {
				trigger = has_variable
				ccw_has_join_war = { join_war_as_defender = { war = scope:target_war call_in_subjects = yes } }
				ccw_has_mercs = { ccw_support_war_side_not_war_join_effect = { type = mercs target = scope:from_country } }
				ccw_has_gold = { ccw_support_war_side_not_war_join_effect = { type = gold target = scope:from_country } }
			}
		}
	}
}
#Loyalists do not join Castile
castilian_civil_war.202 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.202.title
	desc = castilian_civil_war.202.desc
	illustration_tags = {
		10 = armed
		10 = exterior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	#Blasted cowards!
	option = {
		name = castilian_civil_war.202.a
	}
}

#Loyalists can join Castile
castilian_civil_war.300 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.100.title.war
	desc = castilian_civil_war.100.desc.war
	illustration_tags = {
		10 = armed
		10 = exterior
	}
	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		save_scope_as = target_country
	}
	#The time is ripe to join into the fray!
	option = {
		name = castilian_civil_war.200.join_war
		trigger = {
			OR = {
				is_ai = no
				tag = POR
				tag = ARA
				culture = culture:portuguese
				culture = culture:aragonese
				culture = culture:catalan
			}
		}
		historical_option = yes
		show_as_tooltip = {
			join_war_as_attacker = { war = scope:target_war call_in_subjects = yes }
		}
		set_variable = ccw_has_join_war
		set_variable = ccw_has_helped_in_war
		scope:from_country = { trigger_event_silently = castilian_civil_war.301 }
	}
	#The time is ripe to join into the fray!
	option = {
		name = castilian_civil_war.200.mercs
		show_as_tooltip = {
			ccw_support_war_side_not_war_join_effect = { type = mercs target = scope:target_rebel_country }
		}
		set_variable = ccw_has_mercs
		set_variable = ccw_has_helped_in_war
		scope:from_country = { trigger_event_silently = castilian_civil_war.301 }
	}
	#The time is ripe to join into the fray!
	option = {
		name = castilian_civil_war.200.gold
		show_as_tooltip = {
			ccw_support_war_side_not_war_join_effect = { type = gold target = scope:target_rebel_country }
		}
		set_variable = ccw_has_gold
		set_variable = ccw_has_helped_in_war
		scope:from_country = { trigger_event_silently = castilian_civil_war.301 }
	}
	#We cannot afford getting involved in their issues
	option = {
		name = castilian_civil_war.200.coward
		scope:from_country = { trigger_event_silently = castilian_civil_war.302 }
	}
}
#Rebels attack Castile
castilian_civil_war.301 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.301.title
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = { scope:target_country = { has_variable = ccw_has_join_war } }
				desc = castilian_civil_war.301.desc.join_war
			}
			triggered_desc = {
				trigger = { scope:target_country = { has_variable = ccw_has_mercs } }
				desc = castilian_civil_war.301.desc.mercs
			}
			triggered_desc = {
				trigger = { scope:target_country = { has_variable = ccw_has_gold } }
				desc = castilian_civil_war.301.desc.gold
			}
			triggered_desc = {
				desc = castilian_civil_war.301.desc
			}
		}
	}
	after = {
		scope:target_country = {
			if = { limit = { has_variable = ccw_has_join_war } 	remove_variable = ccw_has_join_war }
			if = { limit = { has_variable = ccw_has_mercs } 	remove_variable = ccw_has_mercs }
			if = { limit = { has_variable = ccw_has_gold } 		remove_variable = ccw_has_gold }
		}
	}
	illustration_tags = {
		10 = armed
		10 = exterior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	#At least we can count on their support
	option = {
		name = castilian_civil_war.301.a
		scope:target_country = {
			switch = {
				trigger = has_variable
				ccw_has_join_war = { join_war_as_attacker = { war = scope:target_war call_in_subjects = yes } }
				ccw_has_mercs = { ccw_support_war_side_not_war_join_effect = { type = mercs target = scope:target_rebel_country } }
				ccw_has_gold = { ccw_support_war_side_not_war_join_effect = { type = gold target = scope:target_rebel_country } }
			}
		}
	}
}
#Rebels do not attack Castile
castilian_civil_war.302 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.302.title
	desc = castilian_civil_war.302.desc
	illustration_tags = {
		10 = armed
		10 = exterior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	#Blasted cowards!
	option = {
		name = castilian_civil_war.302.a
	}
}

#############################
# Disaster aftermath events #
#############################
#Aftermath of the Civil War (Victory)
castilian_civil_war.400 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.400.title
	desc = castilian_civil_war.400.desc
	illustration_tags = {
		10 = armed
		10 = exterior
	}
	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		save_scope_as = from_country
		ccw_set_ruler_pretender_scopes = yes
		scope:target_ruler = { save_scope_as = target_winner }
		scope:target_pretender = { save_scope_as = target_loser }
		character:cas_alfonso_xi_burgundy = { save_scope_as = target_father }
		kill_character = {
			target = scope:target_loser
			reason = combat
			killer = scope:target_winner
		}
		ccw_setup_rewards_for_joining_side = yes
	}
	after = {
		#Clean up all the variables
		ccw_clear_variables = yes
	}
	#Long live the King!
	option = {
		name = castilian_civil_war.400.a
		add_stability = stability_mild_bonus
		set_variable = castilian_civil_war_over
		every_in_global_list = {
			variable = ccw_loyalists_side
			if = {
				limit = { has_variable = ccw_has_helped_in_war }
				trigger_event_non_silently = castilian_civil_war.410
				remove_variable = ccw_has_helped_in_war
			}
		}
		every_in_global_list = {
			variable = ccw_rebels_side
			if = {
				limit = { has_variable = ccw_has_helped_in_war }
				trigger_event_non_silently = castilian_civil_war.420
				remove_variable = ccw_has_helped_in_war
			}
		}
	}
}

#Aftermath of the Civil War (Triggered for the Pretender Rebel country)
castilian_civil_war.401 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.400.title
	desc = castilian_civil_war.401.desc
	illustration_tags = {
		10 = armed
		10 = exterior
	}
	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		save_scope_as = from_country
		if = {
			limit = { has_variable = ccw_pretender_character }
			var:ccw_pretender_character = { save_scope_as = target_winner }
		}
		if = {
			limit = { has_variable = ccw_ruler_character }
			var:ccw_ruler_character = { save_scope_as = target_loser }
		}
		kill_character = {
			target = scope:target_loser
			reason = assassination
			killer = scope:target_winner
		}
		ccw_setup_rewards_for_joining_side = yes
	}
	after = {
		#Clean up all the variables
		ccw_clear_variables = yes
	}
	#Long live the King!
	option = {
		name = castilian_civil_war.401.a
		if = {
			limit = {
				has_variable = ccw_pretender_character
				NOT = { exists = scope:target_winner }
			}
			var:ccw_pretender_character = { save_scope_as = target_winner }
		}
		if = {
			limit = {
				has_variable = ccw_ruler_character
				NOT = { exists = scope:target_loser }
			}
			var:ccw_ruler_character = { save_scope_as = target_loser }
		}
		every_in_global_list = {
			variable = ccw_rebels_side
			if = {
				limit = { has_variable = ccw_has_helped_in_war }
				trigger_event_non_silently = castilian_civil_war.410
				remove_variable = ccw_has_helped_in_war
			}
		}
		every_in_global_list = {
			variable = ccw_loyalists_side
			if = {
				limit = { has_variable = ccw_has_helped_in_war }
				trigger_event_non_silently = castilian_civil_war.420
				remove_variable = ccw_has_helped_in_war
			}
		}
	}
}

#Aftermath of the Civil War for Winner-Ally country - The Promises of [target_winner]
castilian_civil_war.410 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.410.title
	desc = castilian_civil_war.410.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		save_scope_as = target_country
	}
	#Time to get our proper reward!
	option = {
		name = castilian_civil_war.410.a
		historical_option = yes
		custom_tooltip = castilian_civil_war.410.a.at
		show_as_tooltip = {
			ccw_grant_reward_for_joining_side = yes
		}
		custom_tooltip = castilian_civil_war.410.a.bt
		show_as_tooltip = {
			ccw_grant_reward_for_getting_demands_rejected = yes
		}
		scope:from_country = { trigger_event_silently = castilian_civil_war.412 }
	}
	#Drop the claims
	option = {
		name = castilian_civil_war.410.b
		scope:from_country = {
			trigger_event_silently = castilian_civil_war.411
			show_as_tooltip = {
				add_opinion = {
					target = scope:target_country
					modifier = opinion_ccw_dropped_claims
				}
			}
		}
	}
}

#target_country wishes for nothing
castilian_civil_war.411 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.411.title
	desc = castilian_civil_war.411.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		clear_saved_scope = target_pretender
		clear_saved_scope = target_loser
		clear_saved_scope = target_ruler
		scope:target_country = {
			if = {
				limit = { has_ruler = yes }
				ruler ?= { save_scope_as = target_ruler }
			}
			else = {
				regent ?= { save_scope_as = target_ruler }
			}
		}
	}
	#Time to get our proper reward!
	option = {
		name = castilian_civil_war.411.a
		add_opinion = {
			target = scope:target_country
			modifier = opinion_ccw_dropped_claims
		}
	}
}

#target_country presses their demands
castilian_civil_war.412 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.412.title
	desc = castilian_civil_war.412.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		clear_saved_scope = target_pretender
		clear_saved_scope = target_loser
		clear_saved_scope = target_ruler
		scope:target_country = {
			if = {
				limit = { has_ruler = yes }
				ruler ?= { save_scope_as = target_ruler }
			}
			else = {
				regent ?= { save_scope_as = target_ruler }
			}
		}
	}
	#Give in to the demands
	option = {
		name = castilian_civil_war.412.a
		custom_tooltip = castilian_civil_war.412.a.tt
		show_as_tooltip = {
			if = {
				limit = {
					scope:target_country = {
						OR = {
							tag = ENG
							culture = culture:english
							tag = FRA
							culture = culture:french
						}
					}
				}
				ccw_grant_reward_for_joining_side_eng_fra = { from = scope:from_country target = scope:target_country }
			}
			else_if = {
				limit = {
					scope:target_country = {
						tag = NAV
					}
				}
				ccw_grant_reward_for_joining_side_nav = { from = scope:from_country target = scope:target_country }
			}
			else_if = {
				limit = {
					scope:target_country = {
						OR = {
							tag = POR
							culture = culture:portuguese
						}
					}
				}
				ccw_grant_reward_for_joining_side_por = { from = scope:from_country target = scope:target_country }
			}
			else_if = {
				limit = {
					scope:target_country = {
						OR = {
							tag = ARA
							culture = culture:catalan
							culture = culture:aragonese
						}
					}
				}
				ccw_grant_reward_for_joining_side_ara = { from = scope:from_country target = scope:target_country }
			}
			else = {
				ccw_grant_reward_for_joining_side_other = { from = scope:from_country target = scope:target_country }
			}
		}
		scope:target_country = { trigger_event_silently = castilian_civil_war.413 }
	}
	#Oh I do not think so
	option = {
		name = castilian_civil_war.412.b
		historical_option = yes
		custom_tooltip = castilian_civil_war.412.a.tt
		show_as_tooltip = {
			ccw_grant_reward_for_getting_demands_rejected = yes
		}
		scope:target_country = { trigger_event_silently = castilian_civil_war.414 }
	}
}

#Castile meets the demands
castilian_civil_war.413 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.413.title
	desc = castilian_civil_war.413.desc
	illustration_tags = {
		10 = happy
		10 = interior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	#Excellent
	option = {
		name = castilian_civil_war.413.a
		if = {
			limit = {
				scope:target_country = {
					OR = {
						tag = ENG
						culture = culture:english
						tag = FRA
						culture = culture:french
					}
				}
			}
			ccw_grant_reward_for_joining_side_eng_fra = { from = scope:from_country target = scope:target_country }
		}
		else_if = {
			limit = {
				scope:target_country = {
					tag = NAV
				}
			}
			ccw_grant_reward_for_joining_side_nav = { from = scope:from_country target = scope:target_country }
		}
		else_if = {
			limit = {
				scope:target_country = {
					OR = {
						tag = POR
						culture = culture:portuguese
					}
				}
			}
			ccw_grant_reward_for_joining_side_por = { from = scope:from_country target = scope:target_country }
		}
		else_if = {
			limit = {
				scope:target_country = {
					OR = {
						tag = ARA
						culture = culture:catalan
						culture = culture:aragonese
					}
				}
			}
			ccw_grant_reward_for_joining_side_ara = { from = scope:from_country target = scope:target_country }
		}
		else = {
			ccw_grant_reward_for_joining_side_other = { from = scope:from_country target = scope:target_country }
		}
	}
}

#Castile refuses to meet the demands
castilian_civil_war.414 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.414.title
	desc = castilian_civil_war.414.desc
	illustration_tags = {
		10 = happy
		10 = interior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	#Excellent
	option = {
		name = castilian_civil_war.414.a
		ccw_grant_reward_for_getting_demands_rejected = yes
	}
}

#Aftermath of the Civil War for Loser-Ally country - The failure of [target_loser]
castilian_civil_war.420 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.420.title
	desc = castilian_civil_war.420.desc
	illustration_tags = {
		10 = armed
		10 = exterior
	}
	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		save_scope_as = target_country
	}
	#A shame...
	option = {
		name = castilian_civil_war.420.a
		#Claim of the House of Burgundy
		if = {
			limit = { tag = POR }
			add_casus_belli = {
				target = scope:from_country
				type = casus_belli:cb_claim_throne
			}
		}
		else = {
			add_prestige = prestige_mild_penalty
		}
	}
}

#########################
# Disaster event chains #
#########################
#Pretender Rebel reaches out to Us! (England / France)
castilian_civil_war.1000 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1000.title
	desc = castilian_civil_war.1000.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	trigger = {
		c:CAS = { has_variable = succession_crisis_pretender_variable }
	}
	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		c:CAS = {
			save_scope_as = from_country
			ccw_set_ruler_pretender_scopes = yes
			ccw_set_legitimate_bastard_scopes = yes
			ccw_set_rebels_scope = yes
			character:cas_alfonso_xi_burgundy = { save_scope_as = from_father }
			character:cas_leonor_guzman = { save_scope_as = from_mother }
		}
		save_scope_as = target_country
		ccw_setup_rewards_for_joining_side = yes
	}
	option = {
		name = castilian_civil_war.1000.a
		historical_option = yes
		#What FRA/ENG will promise to the pretender
		custom_tooltip = castilian_civil_war.1000.a.tt
		#100 Years War promise
		if = {
			limit = { is_situation_active = situation:hundred_years_war }
			custom_tooltip = castilian_civil_war.1000.a.tt.100yw
			if = {
				limit = { country_exists = c:NAV c:NAV = { is_allied_with = { target = root } } }
				c:NAV = { trigger_event_silently = castilian_civil_war.1003 }
			}
		}
		scope:from_country = {
			trigger_event_silently = castilian_civil_war.1001
		}
		ccw_add_to_list = { side = rebels target = scope:target_country } 
		#Promises from the pretender
		ccw_show_reward_for_joining_side = { side = rebels } 
	}
	option = {
		name = castilian_civil_war.1000.b
		custom_tooltip = castilian_civil_war.1000.b.tt
		scope:from_country = {
			trigger_event_silently = castilian_civil_war.1002
		}
	}
}

#Pretender has gained the support of target_country!
castilian_civil_war.1001 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1001.title
	desc = castilian_civil_war.1001.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	option = {
		name = castilian_civil_war.1001.a
		scope:target_country = { ccw_show_reward_for_joining_side = { side = rebels } }
	}
}

#Pretender could not convince target_country!
castilian_civil_war.1002 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1002.title
	desc = castilian_civil_war.1002.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	option = {
		name = castilian_civil_war.1002.a
		custom_tooltip = castilian_civil_war.1002.a.tt
	}
}

#target_country supports the from_country pretender
castilian_civil_war.1003 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1001.title
	desc = castilian_civil_war.1003.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		save_scope_as = root_country
		ccw_setup_rewards_for_joining_side = yes
	}
	option = {
		name = castilian_civil_war.1003.a
		custom_tooltip = {
			text = castilian_civil_war.1003.a.tt
			scope:from_country = {
				trigger_event_silently = castilian_civil_war.1004
			}
			ccw_add_to_list = { side = rebels target = scope:root_country }
		}
		ccw_show_reward_for_joining_side_for_root = { side = rebels }
	}
	option = {
		name = castilian_civil_war.1003.b
		custom_tooltip = castilian_civil_war.1000.b.tt
		scope:from_country = {
			trigger_event_silently = castilian_civil_war.1005
		}
	}
}

#Pretender has gained the support of Navarra!
castilian_civil_war.1004 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1004.title
	desc = castilian_civil_war.1004.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		ccw_set_promised_basque_land_scopes = yes
	}
	option = {
		name = castilian_civil_war.1004.a
		custom_tooltip = castilian_civil_war.1004.a.tt
	}
}

#Pretender could not convince Navarra!
castilian_civil_war.1005 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1005.title
	desc = castilian_civil_war.1005.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	option = {
		name = castilian_civil_war.1005.a
		custom_tooltip = castilian_civil_war.1005.a.tt
	}
}

#Pretender Rebel reaches out to Us! (Aragon / Portugal)
castilian_civil_war.1010 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1000.title
	desc = castilian_civil_war.1000.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		c:CAS = {
			save_scope_as = from_country
			ccw_set_ruler_pretender_scopes = yes
			ccw_set_legitimate_bastard_scopes = yes
			ccw_set_rebels_scope = yes
			character:cas_alfonso_xi_burgundy = { save_scope_as = from_father }
			character:cas_leonor_guzman = { save_scope_as = from_mother }
		}
		save_scope_as = target_country
		ccw_setup_rewards_for_joining_side = yes
	}
	option = {
		name = castilian_civil_war.1000.a
		#What FRA/ENG will promise to the pretender
		custom_tooltip = castilian_civil_war.1000.a.tt
		ccw_add_to_list = { side = rebels target = scope:target_country } 
		scope:from_country = { trigger_event_silently = castilian_civil_war.1011 }
		#Promises from the pretender
		ccw_show_reward_for_joining_side = { side = rebels }
	}
	option = {
		name = castilian_civil_war.1000.b
		custom_tooltip = castilian_civil_war.1000.b.tt
		scope:from_country = {
			trigger_event_silently = castilian_civil_war.1012
		}
	}
}

#Pretender has gained the support of target_country!
castilian_civil_war.1011 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1001.title
	desc = castilian_civil_war.1001.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	option = {
		name = castilian_civil_war.1001.a
		scope:target_country = { ccw_show_reward_for_joining_side = { side = rebels } }
	}
}

#Pretender could not convince target_country!
castilian_civil_war.1012 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1002.title
	desc = castilian_civil_war.1002.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	option = {
		name = castilian_civil_war.1002.a
		custom_tooltip = castilian_civil_war.1002.a.tt
	}
}

#The Pretender's Mother
castilian_civil_war.1020 = {
	type = country_event
	category = disaster_event
	title = {
		first_valid = {
			triggered_desc = {
				trigger = { exists = scope:pretender_mother }
				desc = castilian_civil_war.1020.title
			}
			triggered_desc = {
				trigger = { always = yes }
				desc = castilian_civil_war.1020.title.fallback
			}
		}
	}
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = { has_variable = ccw_sided_with_legal_heir }
				desc = castilian_civil_war.1020.desc.legal_heir
			}
			triggered_desc = {
				trigger = { has_variable = ccw_sided_with_bastard_heir }
				desc = castilian_civil_war.1020.desc.bastard_heir
			}
			triggered_desc = {
				trigger = { always = yes }
				desc = castilian_civil_war.1020.desc
			}
		}
	}
	illustration_tags = {
		10 = angry
		10 = interior
	}
	trigger = {
		has_variable = succession_crisis_pretender_variable
		NOT = { has_variable = ccw_had_mother_event }
		var:succession_crisis_pretender_variable = {
			rebel_progress < 1
		}
		character:cas_maria_portugal = {
			owner = root
			is_alive = yes
		}
		character:cas_leonor_guzman = {
			owner = root
			is_alive = yes
		}
		OR = {
			has_variable = ccw_sided_with_legal_heir
			has_variable = ccw_sided_with_bastard_heir
		}
	}
	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		set_variable = ccw_had_mother_event
		ccw_set_rebels_scope = yes
		character:cas_maria_portugal = { save_scope_as = maria_scope }
		character:cas_leonor_guzman = { save_scope_as = leonor_scope }
		character:cas_alfonso_xi_burgundy = { save_scope_as = alfonso_scope }
		switch = {
			trigger = has_variable
			ccw_sided_with_legal_heir = {
				character:cas_maria_portugal = { save_scope_as = ruler_mother }
				character:cas_leonor_guzman = { save_scope_as = pretender_mother }
			}
			ccw_sided_with_bastard_heir = {
				character:cas_leonor_guzman = { save_scope_as = ruler_mother }
				character:cas_maria_portugal = { save_scope_as = pretender_mother }
			}
		}
		ccw_set_ruler_pretender_scopes = yes
		set_character_siblings_scope = {
			first_sibling = scope:target_ruler
			second_sibling = scope:target_pretender
		}
		save_scope_as = from_country
	}
	#Execute Leonor
	option = {
		name = castilian_civil_war.1020.a
		trigger = { has_variable = ccw_sided_with_legal_heir }
		historical_option = yes
		kill_character = {
			target = scope:pretender_mother
			reason = execution
			killer = scope:ruler_mother
		}
		add_legitimacy = legitimacy_severe_bonus
		scope:target_rebels = { add_rebel_progress = rebel_progress_extreme_penalty }
	}
	#She does not deserve death
	option = {
		name = castilian_civil_war.1020.b
		trigger = { has_variable = ccw_sided_with_legal_heir }
		scope:target_rebels = { add_rebel_progress = rebel_progress_extreme_bonus }
		scope:ruler_mother = {
			banish_character_to_country_effect = { target = c:POR }
		}
		if = {
			limit = { country_exists = c:POR }
			c:POR = { trigger_event_silently = castilian_civil_war.1025 }
		}
		custom_tooltip = {
			text = castilian_civil_war.1020.b.tt
			ordered_character = {
				limit = {
					NOT = { this = scope:ruler_mother }
					NOT = { this = scope:pretender_mother }
					is_alive = yes
					is_adult = yes
					is_ruler = no
					is_heir = no
					is_regent = no
					OR = {
						has_dynasty = no
						NOT = { dynasty = ruler.dynasty }
					}
					NOT = { has_character_modifier = plotting_rebellion_modifier }
				}
				order_by = total_abilities
				max = 3
				check_range_bounds = no
				banish_character_to_country_effect = { target = c:POR }
				set_variable = por_character
			}
		}
	}
	#Banish Maria
	option = {
		name = castilian_civil_war.1020.c
		trigger = { has_variable = ccw_sided_with_bastard_heir }
		scope:pretender_mother = {
			banish_character_to_country_effect = { target = c:POR }
		}
		if = {
			limit = { country_exists = c:POR }
			c:POR = {
				trigger_event_silently = castilian_civil_war.1022
				show_as_tooltip = {
					add_opinion = {
						target = scope:from_country
						modifier = opinion_ccw_banished_maria
					}
				}
			}
		}
		add_legitimacy = legitimacy_severe_bonus
		scope:target_rebels = { add_rebel_progress = rebel_progress_severe_penalty }
	}
	#Keep Maria around
	option = {
		name = castilian_civil_war.1020.d
		trigger = { has_variable = ccw_sided_with_bastard_heir }
		scope:target_rebels = { add_rebel_progress = rebel_progress_severe_bonus }
		add_stability = stability_mild_bonus
		custom_tooltip = {
			text = castilian_civil_war.1020.d.tt
			set_variable = {
				name = ccw_murder_at_court_counter
				value = 1
			}
			trigger_event_silently = {
				id = castilian_civil_war.1021
				days = { 90 365 }
			}
		}
	}
	#Fallback option
	option = {
		name = castilian_civil_war.1020.f
		trigger = {
			NOR = {
				has_variable = ccw_sided_with_legal_heir
				has_variable = ccw_sided_with_bastard_heir
			}
		}
		add_stability = stability_mild_bonus
	}
}

#Murder at the Court
castilian_civil_war.1021 = {
	hide_portraits = yes
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1021.title
	desc = castilian_civil_war.1021.desc
	illustration_tags = {
		10 = angry
		10 = interior
	}
	trigger = {
		has_variable = succession_crisis_pretender_variable
		has_variable = ccw_murder_at_court_counter
		has_variable = ccw_pretender_character
		var:ccw_murder_at_court_counter < 3
		character:cas_maria_portugal = {
			owner = root
			is_alive = yes
		}
		any_character = {
			is_alive = yes
			OR = {
				this = character:cas_leonor_guzman
				has_character_modifier = ccw_ruler_siblings
				this = root.var:ccw_pretender_character
			}
		}
	}
	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		character:cas_maria_portugal = { save_scope_as = murderer_character }
		if = {
			limit = { character:cas_leonor_guzman = { is_alive = yes } }
			character:cas_leonor_guzman = { save_scope_as = target_character }
		}
		else_if = {
			limit = {
				any_character = {
					is_alive = yes
					has_character_modifier = ccw_ruler_siblings
					NOT = { this = root.var:ccw_pretender_character }
				}
			}
			save_scope_as = target_character
		}
		else_if = {
			limit = {
				var:ccw_pretender_character = {
					is_alive = yes
				}
			}
			var:ccw_pretender_character = {
				save_scope_as = target_character
			}
		}
		if = {
			limit = { exists = scope:target_character }
			kill_character_silently = {
				target = scope:target_character
				reason = assassination
				killer = scope:murderer_character
			}
		}
		var:succession_crisis_pretender_variable = {
			save_scope_as = target_rebels
		}
		save_scope_as = from_country
	}
	#Expel Maria
	option = {
		name = castilian_civil_war.1021.a
		scope:murderer_character = {
			banish_character_to_country_effect = { target = c:POR }
		}
		add_prestige = prestige_severe_penalty
		add_legitimacy = legitimacy_mild_bonus
		scope:target_rebels = { add_rebel_progress = rebel_progress_mild_penalty }
		if = {
			limit = { country_exists = c:POR }
			c:POR = {
				trigger_event_silently = castilian_civil_war.1022
				show_as_tooltip = {
					add_opinion = {
						target = scope:from_country
						modifier = opinion_ccw_banished_maria
					}
				}
			}
		}
	}
	#Execute Maria
	option = {
		name = castilian_civil_war.1021.b
		kill_character = {
			target = scope:murderer_character
			reason = execution
		}
		add_prestige = prestige_severe_penalty
		add_legitimacy = legitimacy_severe_bonus
		scope:target_rebels = { add_rebel_progress = rebel_progress_severe_penalty }
		if = {
			limit = { country_exists = c:POR }
			c:POR = {
				trigger_event_silently = castilian_civil_war.1023
				show_as_tooltip = {
					add_opinion = {
						target = scope:from_country
						modifier = opinion_ccw_executed_maria
					}
				}
			}
		}
	}
	#Endure her tomfolery
	option = {
		name = castilian_civil_war.1021.c
		add_prestige = prestige_severe_penalty
		trigger_event_silently = {
			id = castilian_civil_war.1024
			days = { 90 365 }
		}
	}
}

#The Banismeht of Maria
castilian_civil_war.1022 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1022.title
	desc = castilian_civil_war.1022.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		save_scope_as = target_country
		character:cas_maria_portugal = { save_scope_as = maria_scope }
		character:cas_alfonso_xi_burgundy = { save_scope_as = alfonso_scope }
	}
	option = {
		name = castilian_civil_war.1022.a
		add_opinion = {
			target = scope:from_country
			modifier = opinion_ccw_banished_maria
		}
	}
}

#The Execution of Maria
castilian_civil_war.1023 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1023.title
	desc = castilian_civil_war.1023.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		save_scope_as = target_country
		character:cas_maria_portugal = { save_scope_as = maria_scope }
		character:cas_alfonso_xi_burgundy = { save_scope_as = alfonso_scope }
	}
	option = {
		name = castilian_civil_war.1023.a
		add_opinion = {
			target = scope:from_country
			modifier = opinion_ccw_executed_maria
		}
	}
}

#Rumors of a new Plot
castilian_civil_war.1024 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1024.title
	desc = castilian_civil_war.1024.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	option = {
		name = castilian_civil_war.1024.a
		trigger_event_silently = {
			id = castilian_civil_war.1021
			days = { 90 365 }
		}
	}
}

#Return of Maria
castilian_civil_war.1025 = {
	hide_portraits = yes
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1025.title
	desc = castilian_civil_war.1025.desc
	illustration_tags = {
		10 = happy
		10 = interior
	}
	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		save_scope_as = target_country
		random_character = {
			limit = {
				has_variable = por_character
			}
			remove_variable = por_character
			save_scope_as = por_character_1
		}
		random_character = {
			limit = {
				has_variable = por_character
				NOT = { this = scope:por_character_1 }
			}
			remove_variable = por_character
			save_scope_as = por_character_2
		}
		random_character = {
			limit = {
				has_variable = por_character
				NOT = { this = scope:por_character_1 }
				NOT = { this = scope:por_character_2 }
			}
			remove_variable = por_character
			save_scope_as = por_character_3
		}
	}
	option = {
		name = castilian_civil_war.1025.a
		show_as_tooltip = {
			scope:maria_scope = { move_country = scope:target_country }
			if = {
				limit = { exists = scope:por_character_1 }
				scope:por_character_1 = { move_country = scope:target_country }
			}
			if = {
				limit = { exists = scope:por_character_2 }
				scope:por_character_2 = { move_country = scope:target_country }
			}
			if = {
				limit = { exists = scope:por_character_3 }
				scope:por_character_3 = { move_country = scope:target_country }
			}
		}
	}
}

#Allies to the Crown (targets France if ruler is bastard, or England if ruler is legitimate)
castilian_civil_war.1030 = {
	hide_portraits = yes
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1030.title
	desc = castilian_civil_war.1030.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		save_scope_as = from_country
		ccw_set_ruler_pretender_scopes = yes
		ccw_set_legitimate_bastard_scopes = yes
		ccw_set_rebels_scope = yes
		character:cas_alfonso_xi_burgundy = { save_scope_as = from_father }
		character:cas_leonor_guzman = { save_scope_as = from_mother }
		switch = {
			trigger = has_variable
			ccw_sided_with_legal_heir = {
				c:ENG = { save_scope_as = target_country }
			}
			ccw_sided_with_bastard_heir = {
				c:FRA = { save_scope_as = target_country }
			}
		}
		ccw_setup_rewards_for_joining_side = yes
	}
	option = {
		name = castilian_civil_war.1030.a
		custom_tooltip = {
			text = castilian_civil_war.1030.a.tt
			scope:target_country = {
				trigger_event_silently = castilian_civil_war.1031
			}
		}
	}
	option = {
		name = castilian_civil_war.1030.b
		add_prestige = prestige_weak_bonus
	}
}

#A Castilian Alliance? (France / England)
castilian_civil_war.1031 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1031.title
	desc = castilian_civil_war.1031.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	option = {
		name = castilian_civil_war.1000.a
		historical_option = yes
		#What FRA/ENG will promise to the pretender
		custom_tooltip = {
			text = castilian_civil_war.1031.a.tt
			scope:from_country = {
				trigger_event_silently = castilian_civil_war.1032
			}
		}
		show_as_tooltip = {
			ccw_joins_ruler_side_effect = yes
		}
	}
	option = {
		name = castilian_civil_war.1031.b
		custom_tooltip = {
			text = castilian_civil_war.1031.b.tt
			scope:from_country = {
				trigger_event_silently = castilian_civil_war.1039
			}
		}
	}
	option = {
		name = castilian_civil_war.1000.b
		custom_tooltip = {
			text = castilian_civil_war.1000.b.tt
			scope:from_country = {
				trigger_event_silently = castilian_civil_war.1040
			}
		}
	}
}

#France/England accept under these conditions...
castilian_civil_war.1032 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1032.title
	desc = castilian_civil_war.1032.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	option = {
		name = castilian_civil_war.1032.a
		historical_option = yes
		custom_tooltip = {
			text = castilian_civil_war.1032.a.tt
			scope:target_country = {
				trigger_event_silently = castilian_civil_war.1033
			}
		}
		show_as_tooltip = {
			scope:target_country = { ccw_joins_ruler_side_effect = yes }
		}
	}
	option = {
		name = castilian_civil_war.1032.b
		custom_tooltip = {
			text = castilian_civil_war.1032.b.tt
			scope:target_country = {
				trigger_event_silently = castilian_civil_war.1034
			}
		}
	}
}

#Castile accepts our Conditions!
castilian_civil_war.1033 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1033.title
	desc = castilian_civil_war.1033.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	option = {
		name = castilian_civil_war.1033.a
		ccw_joins_ruler_side_effect = yes
	}
}

#Castile rejects our Conditions...
castilian_civil_war.1034 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1034.title
	desc = castilian_civil_war.1034.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	option = {
		name = castilian_civil_war.1034.a
		custom_tooltip = castilian_civil_war.1000.b.tt
	}
}

#Question of Navarra (triggers if France/England has Navarra on their side during the HYW)
castilian_civil_war.1035 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1035.title
	desc = castilian_civil_war.1035.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		c:NAV = { save_scope_as = root_country }
		ccw_set_promised_basque_land_scopes = yes
		ccw_set_rebels_scope = yes
	}
	option = {
		name = castilian_civil_war.1035.a
		custom_tooltip = {
			text = castilian_civil_war.1035.a.tt
			scope:root_country = {
				trigger_event_silently = castilian_civil_war.1036
			}
		}
	}
	option = {
		name = castilian_civil_war.1035.b
	}
}

#Castile requests our Support
castilian_civil_war.1036 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1031.title
	desc = castilian_civil_war.1036.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	option = {
		name = castilian_civil_war.1036.a
		custom_tooltip = {
			text = castilian_civil_war.1036.a.tt
			scope:from_country = {
				trigger_event_silently = castilian_civil_war.1037
			}
			ccw_add_to_list = { side = loyalists target = scope:root_country } 
		}
	}
	option = {
		name = castilian_civil_war.1036.b
		custom_tooltip = {
			text = castilian_civil_war.1000.b.tt
			scope:from_country = {
				trigger_event_silently = castilian_civil_war.1038
			}
		}
	}
}

#Navarra accepts
castilian_civil_war.1037 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1037.title
	desc = castilian_civil_war.1037.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	option = {
		name = castilian_civil_war.1037.a
		custom_tooltip = castilian_civil_war.1037.a.tt
	}
}

#Navarra rejects
castilian_civil_war.1038 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1038.title
	desc = castilian_civil_war.1038.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	option = {
		name = castilian_civil_war.1038.a
		custom_tooltip = castilian_civil_war.1005.a.tt
	}
}

#France/England accepts
castilian_civil_war.1039 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1039.title
	desc = castilian_civil_war.1039.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	option = {
		name = castilian_civil_war.1039.a
		custom_tooltip = castilian_civil_war.1031.a.tt.join_war	
		ccw_add_to_list = { side = loyalists target = scope:target_country } 
		if = {
			limit = {
				is_situation_active = situation:hundred_years_war	#Navarra is only involved when the 100yw is active too
				country_exists = c:NAV
				c:NAV = { is_allied_with = { target = scope:target_country } }
			}
			trigger_event_silently = castilian_civil_war.1035
		}
	}
}

#France/England rejects
castilian_civil_war.1040 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1040.title
	desc = castilian_civil_war.1040.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	option = {
		name = castilian_civil_war.1040.a
		custom_tooltip = castilian_civil_war.1002.a.tt
	}
}

#Iberian Intervention (targets Portugal if ruler is legitimate, or Aragon if ruler is bastard)
castilian_civil_war.1050 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1050.title
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = { has_variable = ccw_sided_with_legal_heir }
				desc = castilian_civil_war.1050.desc.portugal
			}
			triggered_desc = {
				trigger = { has_variable = ccw_sided_with_bastard_heir }
				desc = castilian_civil_war.1050.desc.aragon
			}
			triggered_desc = {
				trigger = { always = yes }
				desc = castilian_civil_war.1050.desc
			}
		}
	}
	illustration_tags = {
		10 = armed
		10 = exterior
	}
	trigger = {
		OR = {
			AND = {
				has_variable = ccw_sided_with_legal_heir
				country_exists = c:POR
			}
			AND = {
				has_variable = ccw_sided_with_bastard_heir
				country_exists = c:ARA
			}
		}
	}
	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		ccw_set_ruler_pretender_scopes = yes
		character:cas_maria_portugal = { save_scope_as = maria_scope }
		save_scope_as = from_country
		switch = {
			trigger = has_variable
			ccw_sided_with_legal_heir = {
				c:POR = {
					save_scope_as = target_country
				}
			}
			ccw_sided_with_bastard_heir = {
				c:ARA = {
					save_scope_as = target_country
				}
			}
		}
		ccw_setup_rewards_for_joining_side = yes
		ccw_set_rebels_scope = yes
	}
	option = {
		name = castilian_civil_war.1030.a
		custom_tooltip = {
			text = castilian_civil_war.1030.a.tt
			scope:target_country = {
				trigger_event_silently = castilian_civil_war.1051
			}
		}
	}
	#Let us not get them involved...
	option = {
		name = castilian_civil_war.1030.b
		add_prestige = prestige_weak_bonus
	}
}

#The Castilian Situation
castilian_civil_war.1051 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1031.title
	desc = castilian_civil_war.1031.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		character:cas_alfonso_xi_burgundy = { save_scope_as = from_father }
		character:cas_leonor_guzman = { save_scope_as = from_mother }
		scope:from_country = { ccw_set_legitimate_bastard_scopes = yes }
	}
	option = {
		name = castilian_civil_war.1000.a
		historical_option = yes
		#What ARA/POR will promise to the ruler
		custom_tooltip = {
			text = castilian_civil_war.1031.a.tt
			scope:from_country = {
				trigger_event_silently = castilian_civil_war.1052
			}
		}
		show_as_tooltip = {
			ccw_joins_ruler_side_effect = yes
		}
	}
	option = {
		name = castilian_civil_war.1031.b
		custom_tooltip = {
			text = castilian_civil_war.1031.b.tt
			scope:from_country = {
				trigger_event_silently = castilian_civil_war.1055
			}
		}
	}
	option = {
		name = castilian_civil_war.1000.b
		custom_tooltip = {
			text = castilian_civil_war.1000.b.tt
			scope:from_country = {
				trigger_event_silently = castilian_civil_war.1056
			}
		}
	}
}

#Portugal/Aragon accept under these conditions...
castilian_civil_war.1052 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1032.title
	desc = castilian_civil_war.1032.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	option = {
		name = castilian_civil_war.1032.a
		historical_option = yes
		custom_tooltip = {
			text = castilian_civil_war.1032.a.tt
			scope:target_country = {
				trigger_event_silently = castilian_civil_war.1053
			}
		}
		show_as_tooltip = {
			scope:target_country = { ccw_joins_ruler_side_effect = yes }
		}
	}
	option = {
		name = castilian_civil_war.1032.b
		custom_tooltip = {
			text = castilian_civil_war.1032.b.tt
			scope:target_country = {
				trigger_event_silently = castilian_civil_war.1054
			}
		}
	}
}

#Castile accepts our Conditions!
castilian_civil_war.1053 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1033.title
	desc = castilian_civil_war.1033.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	option = {
		name = castilian_civil_war.1033.a
		ccw_joins_ruler_side_effect = yes
	}
}

#Castile rejects our Conditions...
castilian_civil_war.1054 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1034.title
	desc = castilian_civil_war.1034.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	option = {
		name = castilian_civil_war.1034.a
		custom_tooltip = castilian_civil_war.1000.b.tt
	}
}

#Portugal/Aragon accepts without further conditions
castilian_civil_war.1055 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1039.title
	desc = castilian_civil_war.1039.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	option = {
		name = castilian_civil_war.1039.a
		custom_tooltip = castilian_civil_war.1031.a.tt.join_war	
		ccw_add_to_list = { side = loyalists target = scope:target_country }
	}
}

#Portugal/Aragon refuses to get involved
castilian_civil_war.1056 = {
	type = country_event
	category = disaster_event
	title = castilian_civil_war.1040.title
	desc = castilian_civil_war.1040.desc
	illustration_tags = {
		10 = regular
		10 = interior
	}
	immediate = { event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate } }
	option = {
		name = castilian_civil_war.1040.a
		custom_tooltip = castilian_civil_war.1002.a.tt
	}
}