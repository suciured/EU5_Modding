namespace = decline_of_majapahit

decline_of_majapahit.1 = {
	type = country_event
    category = disaster_event
	title = decline_of_majapahit.1.title
	desc = decline_of_majapahit.1.desc
	image = "gfx/interface/illustrations/disaster/death_of_hayan_wuruk.dds"


	option = {
		name = decline_of_majapahit.1.a

		add_prestige = prestige_extreme_penalty
		add_legitimacy = legitimacy_extreme_penalty

		custom_tooltip = maj_disaster_tt
	}
}

decline_of_majapahit.2 = {
	type = country_event
    category = disaster_event
	title = decline_of_majapahit.2.title
	desc = decline_of_majapahit.2.desc
	image = "gfx/interface/illustrations/disaster/death_of_hayan_wuruk.dds"

	trigger = {
		num_subjects >= 1
	}


	immediate = {
		random_subject = {
			weight = {
				base = 1
				modifier = {
					add = liberty_desire
				}
			}
			save_scope_as = maj_tributary_country
		}
	}

	option = {
		name = decline_of_majapahit.2.a

		ai_chance = {
			factor = 1
		}

		scope:maj_tributary_country = {
			add_liberty_desire = liberty_desire_severe_plus
		}
	}
	option = {
		name = decline_of_majapahit.2.b

		ai_chance = {
			factor = 1
			modifier = {
				factor = 5
				scope:maj_tributary_country = {
					liberty_desire >= 40
				}
			}
			modifier = {
				factor = 0.5
				legitimacy <= 60
			}
			modifier = {
				factor = 0.5
				legitimacy <= 30
			}
		}

		add_legitimacy = legitimacy_mild_penalty
		scope:maj_tributary_country = {
			add_liberty_desire = liberty_desire_mild_minus
		}
	}
}

scripted_trigger can_be_targetted_by_decline_of_majapahit_3 = {
	power_projection > root.power_projection
	NOT = {
		ROOT = { has_casus_belli_on = PREV }
	}
	NOT = {
		is_subject_or_below_of = ROOT
	}
	NOT = {
		is_allied_with = {
			target = ROOT
		}
	}
}
decline_of_majapahit.3 = {
	hide_portraits = yes
	type = country_event
    category = disaster_event
	title = decline_of_majapahit.3.title
	desc = decline_of_majapahit.3.desc
	image = "gfx/interface/illustrations/disaster/death_of_hayan_wuruk.dds"

	trigger = {
		OR = {
			region:indonesia_region = {
				any_present_country = {
					can_be_targetted_by_decline_of_majapahit_3 = yes
				}
			}
			area:malay_peninsula_area = {
				any_present_country = {
					can_be_targetted_by_decline_of_majapahit_3 = yes
				}
			}
		}
	}


	immediate = {
	
		region:indonesia_region = {
			every_present_country = {
				limit = {
					can_be_targetted_by_decline_of_majapahit_3 = yes
				}
				add_to_list = stronger_countries
			}
		}
		area:malay_peninsula_area = {
			every_present_country = {
				limit = {
					can_be_targetted_by_decline_of_majapahit_3 = yes
				}
				add_to_list = stronger_countries
			}
		}
		random_in_list = {
			list = stronger_countries
			weight = {
				factor = 0
				modifier = {
					add = {
						value = power_projection
						subtract = root.power_projection
					}
				}
			}
			save_scope_as = target_country
			ruler_or_regent ?= {
				save_scope_as = target_character
			}
		}
	}

	option = {
		name = decline_of_majapahit.3.a

		ai_chance = {
			factor = 0.75
		}

		scope:target_country = {
			add_opinion = {
				modifier = opinion_insulted
				target = ROOT
			}
		}
		change_societal_value = {
			type = belligerent_vs_conciliatory
			value = societal_value_move_to_left
		}

		add_casus_belli = {
			target = scope:target_country
			type = casus_belli:cb_insulted_us
		}
	}
	option = {
		name = decline_of_majapahit.3.b

		ai_chance = {
			factor = 0.25
		}

		add_prestige = prestige_severe_penalty
		add_stability = stability_weak_bonus
	}
}

decline_of_majapahit.4 = {
	type = country_event
    category = disaster_event
	title = decline_of_majapahit.4.title
	desc = decline_of_majapahit.4.desc
	image = "gfx/interface/illustrations/disaster/death_of_hayan_wuruk.dds"

	trigger = {
		any_province = {
			area = area:java_area
			NOT = { has_province_modifier = maj_province_discontent }
		}
	}


	immediate = {
		random_province = {
			limit = {
				NOT = { has_province_modifier = maj_province_discontent }
				area = area:java_area
			}
			save_scope_as = target_province
			random_location_in_province = {
				random_pop = {
					save_scope_as = target_pop
				}
			}
		}
		set_local_variable = {
			name = maj_cost_to_remove_discontent
			value = {
				value = yearly_gold
				multiply = -0.5
			}
		}
	}

	option = {
		name = decline_of_majapahit.4.a

		ai_chance = {
			factor = 0.25
		}

		scope:target_province = {
			add_province_modifier = {
				mode = add_and_extend
				modifier = maj_province_discontent
				years = 5
			}
		}

		add_legitimacy = legitimacy_severe_penalty
	}
	option = {
		name = decline_of_majapahit.4.b

		ai_chance = {
			factor = 0.75
			modifier = {
				factor = 0
				gold <= {
					value = local_var:maj_cost_to_remove_discontent
					multiply = -2
				}
			}
		}

		add_gold = local_var:maj_cost_to_remove_discontent

		add_estate_satisfaction = {
			type = estate_type:peasants_estate
			value = estate_satisfaction_weak_bonus
		}
	}
}

decline_of_majapahit.5 = {
	hide_portraits = yes
	type = country_event
    category = disaster_event
	title = decline_of_majapahit.5.title
	desc = decline_of_majapahit.5.desc
	image = "gfx/interface/illustrations/disaster/death_of_hayan_wuruk.dds"


	trigger = {
		ruler_or_heir_if_regent ?= {
			has_dynasty = yes
		}
		NOT = {
			any_rebel = {
				rebel_category = pretender
			}
		}
	}

	immediate = {

		random_character = {
			limit = {
				can_become_a_ruler = yes
				has_dynasty = yes
				root.ruler_or_heir_if_regent ?= {
					dynasty = PREV.dynasty
				}
				NOT = { is_parent_of = ROOT.ruler }
				NOT = { is_child_of = ROOT.ruler }
			}
			save_scope_as = target_character
		}

		if = {
			limit = {
				NOT = { exists = scope:target_character }
			}
			create_character = {
				estate = estate_type:nobles_estate
				dynasty = root.ruler_or_heir_if_regent.dynasty
				min_age = 20
				culture = root.culture
				religion = root.religion
				save_scope_as = target_character
			}
		}

		create_rebel = {
			category = pretender
			name = majapahit_pretender_rebels
			save_scope_as = target_rebels
		}

		scope:target_character = {
			change_character_allegiance = scope:target_rebels
		}
	}

	option = {
		name = decline_of_majapahit.5.a

		add_legitimacy = legitimacy_weak_penalty

		custom_tooltip = maj_every_pop_in_capital_province
		show_as_tooltip = {
			capital = {
				random_pop = {
					change_pop_allegiance = scope:target_rebels
					add_pop_satisfaction = pop_satisfaction_extreme_penalty
				}
			}
		}

		hidden_effect = {
			capital.province = {
				every_location_in_province = {
					every_pop = {
						change_pop_allegiance = scope:target_rebels
						add_pop_satisfaction = pop_satisfaction_extreme_penalty
					}
				}
			}
		}
	}
}

# Hindu Flee to Bali
decline_of_majapahit.6 = {
	type = country_event
    category = disaster_event
	title = decline_of_majapahit.6.title
	desc = decline_of_majapahit.6.desc
	image = "gfx/interface/illustrations/disaster/death_of_hayan_wuruk.dds"

	trigger = {
		exists = province:bali_province
		dominant_religion = religion:sunni
	}


	fire_only_once = yes

	immediate = {
		province:bali_province = {
			save_scope_as = target_province
		}
		religion = {
			save_scope_as = target_religion
		}
		religion:sunni = {
			save_scope_as = target_religion2
		}
		random_pop = {
			limit = {
				religion = ROOT.religion
			}
			save_scope_as = target_pop
		}
		random_pop = {
			limit = {
				religion = ROOT.religion
				pop_type = pop_type:clergy
			}
			save_scope_as = target_pop
		}
	}

	option = {
		name = decline_of_majapahit.6.a

		ordered_pop = {
			limit = {
				location.area = area:java_area
				religion = root.religion
				OR = {
					pop_type = pop_type:nobles
					pop_type = pop_type:clergy
				}
			}
			order_by = pop_size
			max = 5
			add_migration = {
				amount = {
					value = pop_size
					multiply = 0.5
				}
				from = location.province_definition
				owner = ROOT
				to = scope:target_province.province_definition
				religion = root.religion
				culture = culture
				months = 12
			}
		}
	}
}

# Adipati Converts to Islam
decline_of_majapahit.7 = {
	type = country_event
    category = disaster_event
	title = decline_of_majapahit.7.title
	desc = decline_of_majapahit.7.desc
	image = "gfx/interface/illustrations/disaster/death_of_hayan_wuruk.dds"



	trigger = {
		NOT = { has_country_modifier = adipati_conversion_ban }
		any_owned_location = {
			dominant_religion = religion:sunni
			province = { 
				NOT = { has_variable = decline_of_majapahit_7cd_variable }
			}
			is_core_of = ROOT
		}
	}

	immediate = {
		random_owned_location = {
			limit = {
				dominant_religion = religion:sunni
				is_core_of = ROOT
				province = { 
					NOT = { has_variable = decline_of_majapahit_7cd_variable }
				}
			}
			save_scope_as = target_location
			province = {
				set_variable = {
					name = decline_of_majapahit_7cd_variable
					years = 10
				}
			}
			random_pop = {
				limit = {
					religion = religion:sunni
				}
				save_scope_as = target_pop
			}
		}
	}

	option = {
		name = decline_of_majapahit.7.a

		scope:target_location = {
			remove_core = ROOT
			change_control = control_severe_penalty
			province = {
				every_location_in_province = {
					limit = {
						this != scope:target_location
						dominant_religion = religion:sunni
						integration_level = core
					}
					remove_core = ROOT
				}
			}
		}
	}
}

# An Offer of Aid
decline_of_majapahit.8 = {
	type = country_event
    category = disaster_event
	title = decline_of_majapahit.8.title
	desc = decline_of_majapahit.8.desc
	fire_only_once = yes
	image = "gfx/interface/illustrations/disaster/death_of_hayan_wuruk.dds"

	immediate = {
		set_local_variable = {
			name = gold_gain
			value = {
				value = yearly_gold
				multiply = 2
			}
		}
		random_pop = {
			limit = {
				religion = religion:sunni
			}
			save_scope_as = target_pop
		}
	}

	option = {
		name = decline_of_majapahit.8.a

		add_country_modifier = {
			mode = add_and_extend
			modifier = maj_muslim_aid
			years = -1
		}
		custom_tooltip = maj_muslim_aid_impact

		add_gold = local_var:gold_gain

		add_estate_satisfaction = {
			type = estate_type:burghers_estate
			value = estate_satisfaction_mild_bonus
		}
	}

	option = {
		name = decline_of_majapahit.8.b

		add_estate_satisfaction = {
			type = estate_type:clergy_estate
			value = estate_satisfaction_extreme_bonus
		}
	}
}

# A New Dawn for Majapahit
decline_of_majapahit.100 = {
	type = country_event
    category = disaster_event
	title = decline_of_majapahit.100.title
	desc = decline_of_majapahit.100.desc
	image = "gfx/interface/illustrations/disaster/death_of_hayan_wuruk.dds"
	fire_only_once = yes

	immediate = {
		character:maj_gajah_mada = {
			save_scope_as = target_character
		}
	}

	option = {
		name = decline_of_majapahit.100.a

		add_stability = stability_severe_bonus
		add_country_modifier = {
			mode = add_and_extend
			modifier = maj_weathered_the_storm
			years = 30
		}
	}
}

# Rise of Mataram
decline_of_majapahit.101 = {
	type = country_event
    category = disaster_event
	title = decline_of_majapahit.101.title
	desc = decline_of_majapahit.101.desc
	image = "gfx/interface/illustrations/disaster/death_of_hayan_wuruk.dds"

	trigger = {
		religion = religion:sunni
	}


	fire_only_once = yes

	immediate = {
		random_pop = {
			limit = {
				religion = religion:sunni
			}
			save_scope_as = target_pop
			save_scope_as = target_pop_bckg
		}
		var:original_majapahit_religion = {
			save_scope_as = target_religion
		}
	}

	option = {
		name =  decline_of_majapahit.101.a

		change_country_tag = MTM
		hidden_effect = {
			change_country_flag = MTM
			change_country_name = MTM
			change_country_adjective = MTM_ADJ
			change_country_color = map_MTM
		}

		every_subject = {
			limit = {
				liberty_desire > 5
			}
			overlord = { cancel_subject = PREV }
		}

		add_legitimacy = legitimacy_radical_penalty
		add_stability = stability_radical_penalty
	}
}

# Rise of Demak
decline_of_majapahit.102 = {
	type = country_event
    category = disaster_event
	title = decline_of_majapahit.102.title
	desc = decline_of_majapahit.102.desc
	image = "gfx/interface/illustrations/disaster/death_of_hayan_wuruk.dds"

	fire_only_once = yes

	immediate = {
		area:java_area = {
			every_location_in_area = {
				limit = {
					dominant_religion = religion:sunni
					owner ?= ROOT
				}
				add_to_list = list_of_demak_locations
			}
		}

		if = { #Fallback
			limit = {
				list_size = {
					name = list_of_demak_locations
					value <= 3
				}
			} 
			ordered_province = {
				order_by = "religion_percentage(religion:sunni)"
				max = 3
				every_location_in_province = {
					add_to_list = list_of_demak_locations
				}
			}
		}

		ordered_in_list = {
			list = list_of_demak_locations
			order_by = pop_size
			max = 1
			save_scope_as = target_location
		}

		if = {
			limit = {
				location:demak = {
					is_in_list = list_of_demak_locations
				}
			}
			location:demak = {
				save_scope_as = target_location
			}
		}

		scope:target_location = {
			random_pop = {
				limit = {
					religion = religion:sunni
				}
				save_scope_as = target_pop
			}

			create_country_from_location = {
				reforms = {
					mandala_system
				}

				change_country_tag = DEM
				hidden_effect = {
					change_country_flag = DEM
					change_country_name = DEM
					change_country_adjective = DEM_ADJ
					change_country_color = map_DEM
				}

				save_scope_as = target_country
			}
		}

		every_in_list = {
			list = list_of_demak_locations
			change_location_owner = scope:target_country
		}

		scope:target_country = {
			ruler = {
				save_scope_as = target_character
			}
		}
	}

	option = {
		name = decline_of_majapahit.102.a

		ai_chance = {
			factor = 0.8
		}

		declare_war_with_cb = {
			target = scope:target_country
			type = casus_belli:cb_annex
		}
		add_prestige = prestige_mild_bonus
		add_legitimacy = legitimacy_severe_bonus
	}

	option = {
		name = decline_of_majapahit.102.b

		ai_chance = {
			factor = 0.2
		}

		change_societal_value = {
			type = belligerent_vs_conciliatory
			value = societal_value_huge_move_to_right
		}
	}
}