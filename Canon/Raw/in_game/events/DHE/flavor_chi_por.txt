namespace = flavor_chi_por

flavor_chi_por.1 = {
	type = country_event
	title = flavor_chi_por.1.title
	desc = flavor_chi_por.1.desc

	fire_only_once = yes
	dynamic_historical_event = {
		tag = POR
		from = 1550.1.1
		to = 1821.1.1
		monthly_chance = 10
	}

	illustration_tags = {
		10 = regular
		10 = interior
	}

	trigger = {
		c:CHI ?= {
			owns = location:xiangshan_xinhui
		}
		location:xiangshan_xinhui = {
			within_naval_range_of = ROOT
		}
	}

	immediate = {
		if = {
			limit = {
				is_ai = no
			}
			event_illustration_estate_background_effect = { background = estate_type:burghers_estate }
			scope:offering_country = {
				event_illustration_estate_foreground_effect = { foreground = estate_type:burghers_estate }
			}
		}
		c:CHI = {
			save_scope_as = target_country
		}
		location:xiangshan_xinhui = {
			save_scope_as = target_location
			random_pop = {
				save_scope_as = target_pop
			}
		}
		building_type:chi_macau_port = {
			save_scope_as = target_building_type
		}
		save_scope_as = offering_country
	}

	option = {
		name = flavor_chi_por.1.a
		
		scope:target_country = {
			trigger_event_non_silently = {
				id = flavor_chi_por.2
			}
		}
	}

	option = {
		name = flavor_chi_por.1.b
		
		add_prestige = prestige_severe_bonus
	}
}

flavor_chi_por.2 = {
	type = country_event
	title = flavor_chi_por.2.title
	desc = flavor_chi_por.2.desc

	illustration_tags = {
        10 = regular
        10 = interior
    }

	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:burghers_estate background = estate_type:burghers_estate }
	}

	option = {
		name = flavor_chi_por.2.a
		
		scope:target_location = {
			construct_building = {
				building_type = building_type:chi_macau_port
				cost_multiplier = 0
				cost_multiplier_reason = "game_concept_event"
				owner = scope:offering_country
				instant = yes
			}
		}

		if = {
			limit = {
				NOR = {
					current_age = age_1_traditions
					current_age = age_2_renaissance
				}
			}
			change_societal_value = {
				type = outward_vs_inward
				value = societal_value_large_move_to_left
			}
		}
		else = {
			add_prestige = prestige_weak_bonus
		}

		add_opinion_mutual_effect = {
			modifier = chi_mutual_trade_agreement_for_macau
			target = scope:offering_country
		}

		scope:offering_country = { set_local_variable = accepted_offer }
	}

	option = {
		name = flavor_chi_por.2.b
		
		add_prestige = prestige_mild_bonus
		if = {
			limit = {
				current_age_or_later = { age = age_4_reformation }
			}
			change_societal_value = {
				type = mercantilism_vs_free_trade
				value = societal_value_minor_move_to_left
			}
		}
	}

	after = {
		scope:offering_country = {
			trigger_event_non_silently = { id = flavor_chi_por.3 }
		}
	}
}

flavor_chi_por.3 = {
	type = country_event
	title = flavor_chi_por.3.title
	desc = {
		first_valid = {
			triggered_desc = {
				desc = flavor_chi_por.3.desc_success
				trigger = {
					has_local_variable = accepted_offer
				}
			}
			triggered_desc = {
				desc = flavor_chi_por.3.desc_failure
				trigger = {
					NOT = { has_local_variable = accepted_offer }
				}
			}
		}
	}

	illustration_tags = {
        10 = regular
        10 = interior
    }

	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:burghers_estate background = estate_type:burghers_estate }
	}

	option = {
		name = flavor_chi_por.3.a
		
		if = {
			limit = {
				has_local_variable = accepted_offer
			}
			change_societal_value = {
				type = mercantilism_vs_free_trade
				value = societal_value_large_move_to_right
			}
		}
		else = {
			add_opinion = {
				modifier = chi_insulted_us
				target = scope:target_country
			}
		}
	}
}