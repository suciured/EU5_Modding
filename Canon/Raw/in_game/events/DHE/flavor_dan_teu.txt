namespace = flavor_dan_teu

#St George's Night Uprising
flavor_dan_teu.1 = {
	type = country_event
	title = flavor_dan_teu.1.title
	desc = flavor_dan_teu.1.desc
	historical_info = flavor_dan_teu.1.historical_info

	fire_only_once = yes
	dynamic_historical_event = {
		tag = DAN
		from = 1343.5.1
		to = 1345.1.1
		monthly_chance = 20
	}

	trigger = {
		province_definition:estonia_province = {
			any_location_in_province_definition = {
				owner = ROOT
			}
		}
	}

	illustration_tags = {
		10 = armed
		10 = exterior
	}

	immediate = {
		save_scope_as = TEU_denmark_from
		create_rebel = {
			category = nationalist
			name = estonian_uprising
			save_scope_as = estonian_uprising
			culture = culture:estonian
			religion = religion:muinaisusko
		}
		province_definition:estonia_province = {
			every_location_in_province_definition = {
				limit = { owner = ROOT }
				every_pop = {
					limit = {
						owner = root
						culture = culture:estonian
					}
					split_pop = {
						fraction = 0.75
						religion = religion:muinaisusko
					}
				}
				every_pop = {
					limit = {
						owner = root
						culture = culture:estonian
					}
					save_scope_as = target_pop
					save_scope_as = target_pop_bckg
					add_pop_satisfaction = pop_satisfaction_ultimate_penalty
					change_pop_allegiance = scope:estonian_uprising
				}
			}
		}
		scope:estonian_uprising = {
			add_rebel_progress = 1.5
		}
		ruler_or_regent = {
			save_scope_as = ruler_or_regentt_scope
		}
	}

	option = {
		name = flavor_dan_teu.1.a		
		historical_option = yes
		
		custom_tooltip = TEU_st_georges_uprising

		show_as_tooltip = {
			scope:estonian_uprising = {
				add_rebel_progress = 1.5
			}
		}
	}

	after = {
		c:TEU = {
			trigger_event_non_silently = {
				id = flavor_dan_teu.2
				days = 40
			}
		}
	}
}

#Rebellion spreads to Livonian Territories
flavor_dan_teu.2 = {
	type = country_event
	title = flavor_dan_teu.2.title
	desc = flavor_dan_teu.2.desc
	historical_info = flavor_dan_teu.1.historical_info
	
	trigger = {
		c:DAN = {
			any_current_war	= {
				#Is Denmark defending from an Estonian Country?
				any_attacker = {
					culture = culture:estonian
				}
				#The Teutons are not already participating in that same war
				NOT = {
					any_war_participant = {
						this = ROOT
					}
				}
			}
		}
	}

	illustration_tags = {
        10 = armed
        10 = exterior
    }

	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:peasants_estate background = estate_type:peasants_estate }
		c:DAN = {
			random_war = {
				limit = {
					any_attacker = {
						culture = culture:estonian
					}
					NOT = {
						any_war_participant = {
							this = ROOT
						}
					}
				}
				save_scope_as = TEU_independence_war_estonian
				random_attacker = {
					limit = {
						culture = culture:estonian
					}
					save_scope_as = the_rebellion
					set_variable = {
						name = estonian_rebellion_flag
						years = 10
					}		
				}
			}
		}
		scope:the_rebellion = {
			trigger_event_silently = flavor_dan_teu.5
		}
		scope:TEU_denmark_from = {
			trigger_event_silently = {
				id = flavor_dan_teu.7
				months = { 2 4 }
			}
		}
	}


	option = {
		name = flavor_dan_teu.2.a
		
		if = {
			limit  = {
				NOT = {
					scope:TEU_independence_war_estonian = {
						any_war_participant = {
							this = ROOT
						}
					}
				}
			}
			join_war_as_defender = { war = scope:TEU_independence_war_estonian }
			location:lihula = {
				change_location_controller = scope:the_rebellion
			}
			location:hapsal = {
				change_location_controller = scope:the_rebellion
			}
			location:valjala = {
				change_location_controller = scope:the_rebellion
			}
			location:kaina = {
				change_location_controller = scope:the_rebellion
			}
			location:kuressaare = {
				change_location_controller = scope:the_rebellion
			}
			every_subject = {
				trigger_event_non_silently = flavor_dan_teu.6
				every_subject = {
					trigger_event_non_silently = flavor_dan_teu.6
				}
			}
		}
	}
}

#Estonians kill German Nobility
flavor_dan_teu.3 = {
	type = country_event
	title = flavor_dan_teu.3.title
	desc = flavor_dan_teu.3.desc

	trigger = {
		has_variable = estonian_rebellion_flag
		country_exists = c:DAN
		NOT = { religion = religion:catholic }
		OR = {
			any_owned_location = {
				any_pop = {
					culture = culture:german_baltic
					religion = religion:catholic
				}
			}
			any_controlled_location = {
				any_pop = {
					culture = culture:german_baltic
					religion = religion:catholic
				}
			}
		}
		any_current_war = {
			is_civil_war_for = c:DAN
			any_defender = { #any_war_enemy
				OR = {
					tag = TEU
					tag = DAN
				}
			}
			any_attacker = {
				this = ROOT
			}
		}
	}

	illustration_tags = {
        10 = armed
        10 = exterior
    }

	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:peasants_estate background = estate_type:peasants_estate }
		every_owned_location = {
			every_pop = {
				limit = {
					culture = culture:german_baltic
				}
				add_to_temporary_list = teu_list_of_baltic_pops
			}
		}
		every_controlled_location = {
			every_pop = {
				limit = {
					culture = culture:german_baltic
				}
				add_to_temporary_list = teu_list_of_baltic_pops
			}
		}
		random_in_local_list = {
			list = teu_list_of_baltic_pops
			save_scope_as = teu_affected_pop
		}
		scope:teu_affected_pop.location = {
			save_scope_as = target_province
		}
		save_scope_as = teu_rebellion_tag
	}

	option = {
		name = flavor_dan_teu.3.a
		
		scope:teu_affected_pop = {
			set_local_variable = {
				name = lost_pops
				value = {
					value = pop_size
					multiply = -0.1
				}
			}
			show_as_tooltip = {
				add_pop_size = {
					value = pop_size
					multiply = -0.1
				}
			}
		}

		hidden_effect = {
			if = {
				limit = {
					scope:teu_affected_pop.location = {
						owner = ROOT
					}
				}
				c:DAN = { trigger_event_non_silently = flavor_dan_teu.4 }
			}
			else = {
				scope:teu_affected_pop.location.owner = {
					trigger_event_non_silently = flavor_dan_teu.4
				}
			}
		}

		change_societal_value = {
			type = belligerent_vs_conciliatory
			value = societal_value_large_move_to_left
		}
	}

	option = {
		name = flavor_dan_teu.3.b
	
		change_societal_value = {
			type = spiritualist_vs_humanist
			value = societal_value_minor_move_to_right
		}
	}
}

#Event informing of the above
flavor_dan_teu.4 = {
	type = country_event
	title = flavor_dan_teu.4.title
	desc = flavor_dan_teu.4.desc

	illustration_tags = {
        10 = armed
        10 = exterior
    }

	immediate = {
		if = {
			limit = {
				is_ai = no
			}
			event_illustration_estate_background_effect = { background = estate_type:peasants_estate }
			scope:teu_affected_pop = {
				save_scope_as = target_pop
			}
		}
	}
	
	option = {
		name = flavor_dan_teu.4.a
		scope:teu_affected_pop = {
			add_pop_size = {
				value = local_var:lost_pops
			}
		}
	}
	after = {
		remove_local_variable = lost_pops
	}
}

#Event for Estonian Rebellion
flavor_dan_teu.5 = {
	type = country_event
	title = flavor_dan_teu.5.title
	desc = flavor_dan_teu.5.desc
	historical_info = flavor_dan_teu.1.historical_info

	illustration_tags = {
        10 = armed
        10 = exterior
    }

	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:peasants_estate background = estate_type:peasants_estate }
	}
	
	option = {
		name = flavor_dan_teu.5.a
		
		every_province = {
			raise_levies = { 
				type = army
				instant = yes
			}
		}
		capital = {
			create_sub_unit = unit_type:a_villagers
		}
		add_country_modifier = {
			modifier = teu_fervor_st_georges_night_uprising
			years = 3
		}
	}
}

#Our Overlord has been attacked by Estonian Rebellion
flavor_dan_teu.6 = {
	type = country_event
	title = flavor_dan_teu.6.title
	desc = flavor_dan_teu.6.desc
	historical_info = flavor_dan_teu.1.historical_info
	
	illustration_tags = {
        10 = armed
        10 = exterior
    }

	immediate = {
		if = {
			limit = {
				is_ai = no
			}
			scope:teu_affected_pop = {
				save_scope_as = target_pop_bckg
			}
			scope:TEU_independence_war_estonian = {
				event_illustration_estate_foreground_effect = { foreground = estate_type:peasants_estate }
			}
		}
	}

	option = {
		name = flavor_dan_teu.6.a

		join_war_as_defender = { war = scope:TEU_independence_war_estonian }
	}
}

#Selling Estonia 
flavor_dan_teu.7 = {
	type = country_event
	title = flavor_dan_teu.7.title
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {
					scope:the_deciding_nation = scope:teu_receives_estonia
				}
				desc = flavor_dan_teu.7.desc_no_hyperlink
			}
			triggered_desc = {
				trigger = {
					always = yes
				}
				desc = flavor_dan_teu.7.desc_hyperlink
			}
		}
	}
	historical_info = flavor_dan_teu.7.historical_info

	trigger = {
		c:TEU = { 
			any_current_war = {
				this = scope:TEU_independence_war_estonian
			}
		}
	}

	illustration_tags = {
        10 = angry
        10 = exterior
    }

	immediate = {	
		scope:TEU_independence_war_estonian = {
			event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		}	
		if = {
			limit = {
				country_exists = c:LIV
				c:LIV = {
					is_subject_of = c:TEU 
				}
			}			
			c:LIV = { save_scope_as = teu_receives_estonia }
		}
		else = {
			c:TEU = { save_scope_as = teu_receives_estonia }
		}
		
		ruler_or_regent = {
			save_scope_as = ruler_or_regent_scope
		}
		scope:teu_receives_estonia = {
			save_scope_as = the_deciding_nation	
		}
		while = {
			limit = {
				scope:the_deciding_nation = {
					is_subject = yes
				}
			}
			scope:the_deciding_nation.overlord = {
				save_scope_as = the_deciding_nation
			}
		}
		scope:the_deciding_nation = {
			ruler_or_regent = {
				save_scope_as = ruler_or_regent_scope_receiver
			}
		}
		set_local_variable = {
			name = teu_price_for_estonia
			value = 0
		}
		province_definition:estonia_province = {
			every_location_in_province_definition = {
				limit = {
					owner = scope:the_rebellion
				}
				change_local_variable = {
					name = teu_price_for_estonia
					add = this.location_tax_base
				}
			}
		}
		change_local_variable = {
			name = teu_price_for_estonia
			multiply = 36
		}
	}

	option = {
		name = flavor_dan_teu.7.a
		
		historical_option = yes
		
		change_societal_value = {
			type = belligerent_vs_conciliatory
			value = societal_value_large_move_to_right
		}

		province_definition:estonia_province = {
			every_location_in_province_definition = {
				limit = {
					owner = scope:the_rebellion
				}
				remove_core = ROOT
			}
		}

		custom_tooltip = teu_if_teutons_accept
		show_as_tooltip = {
			province_definition:estonia_province = {
				every_location_in_province_definition = {
					limit = {
						owner = scope:the_rebellion
					}
					add_core = scope:teu_receives_estonia
				}
			}
			add_gold = local_var:teu_price_for_estonia
			scope:the_deciding_nation = {
				add_gold = {
					value = local_var:teu_price_for_estonia
					multiply = -1
				}
			}
		}
		scope:the_deciding_nation = {
			trigger_event_non_silently = flavor_dan_teu.8
		}
	}

	option = {
		name = flavor_dan_teu.7.b
		
		province_definition:estonia_province = {
			every_location_in_province_definition = {
				limit = {
					owner = scope:the_rebellion
				}
				remove_core = ROOT
			}
		}
	}
}

#Selling Estonia - Teuton Response
flavor_dan_teu.8 = {
	type = country_event
	title = flavor_dan_teu.8.title
	desc = flavor_dan_teu.8.desc
	historical_info = flavor_dan_teu.8.historical_info

	illustration_tags = {
        10 = regular
        10 = interior
    }

	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
	}
	
	option = {
		name = flavor_dan_teu.8.a
		
		historical_option = yes

		
		province_definition:estonia_province = {
			every_location_in_province_definition = {
				limit = {
					owner = scope:the_rebellion
				}
				add_core = scope:teu_receives_estonia
			}
		}

		add_gold = {
			value = local_var:teu_price_for_estonia
			multiply = -1
		}
		show_as_tooltip = {
			scope:TEU_denmark_from = {
				add_gold = local_var:teu_price_for_estonia
			}
		}

		scope:TEU_denmark_from = { set_variable = TEU_teutons_accepted }
	}

	option = {
		name = flavor_dan_teu.8.b
		
		add_prestige = prestige_mild_bonus

		change_societal_value = {
			type = centralization_vs_decentralization
			value = societal_value_large_move_to_left
		}

		scope:TEU_denmark_from = { set_variable = TEU_teutons_denied }
	}

	after = {
		scope:TEU_denmark_from = {
			trigger_event_non_silently = flavor_dan_teu.9
		}
	}
}

#Selling Estonia - Danish Notification
flavor_dan_teu.9 = {
	type = country_event
	title = flavor_dan_teu.9.title
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {
					has_variable = TEU_teutons_accepted
				}
				desc = flavor_dan_teu.9.desc_success
			}
			triggered_desc = {
				trigger = {
					has_variable = TEU_teutons_denied
				}
				desc = flavor_dan_teu.9.desc_failure
			}
		}
	}

	illustration_tags = {
        10 = regular
        10 = interior
    }

	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
	}
	
	option = {
		name = flavor_dan_teu.9.a
		
		trigger = { has_variable = TEU_teutons_accepted }

		add_gold = local_var:teu_price_for_estonia
		add_opinion_mutual_effect = {
			target = scope:the_deciding_nation
			modifier = teu_successful_dealings
		}

		if = {
			limit = {
				scope:TEU_independence_war_estonian = { is_in_war = ROOT } 
			}
			leave_war = {
				war = scope:TEU_independence_war_estonian
				actor = ROOT
			}
			every_subject_or_below = {
				limit = {
					scope:TEU_independence_war_estonian = { is_in_war = PREV } 
				}
				leave_war = {
					war = scope:TEU_independence_war_estonian
					actor = THIS
				}
			}
		}
	}

	option = {
		name = flavor_dan_teu.9.b
		
		trigger = { has_variable = TEU_teutons_denied }
	}

	after = {
		if = {
			limit = {
				has_variable = TEU_teutons_denied
			}
			remove_variable = TEU_teutons_denied
		}
		if = {
			limit = {
				has_variable = TEU_teutons_accepted
			}
			remove_variable = TEU_teutons_accepted
		}
	}
}