namespace = flavor_bei

flavor_bei.1 = {
	hide_portraits = yes
	type = country_event
	fire_only_once = yes
	title = flavor_bei.1.title
	desc = flavor_bei.1.desc
	historical_info = flavor_bei.1.historical_info

	illustration_tags = {
		10 = interior
		10 = regular
	}
	
	dynamic_historical_event = {
		tag = BEI
        tag = GBR
		from = 1350.1.1
		to = 1450.1.1
		monthly_chance = 1
	}
	
	trigger = {
		NOT = {
			religion.group = religion_group:muslim
		}
		ruler ?= {
			is_adult = yes
			is_female = no
			owner = ROOT
			NOT = { religion.group = religion_group:muslim }
		}
	}

	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		ordered_pop = {
			max = 1
			order_by = {
				value =  pop_size
				if = {
					limit = {
						estate_type = estate_type:clergy_estate
					}
					add = 500
				}
				if = {
					limit = {
						religion.group = religion_group:muslim
					}
					add = 1000
				}
			}
			check_range_bounds = no
			save_scope_as = target_pop
			save_scope_as = target_pop_bckg
		}
		ruler = { save_scope_as = target_character }
	}

	option = {
		name = flavor_bei.1.a
		historical_option = yes

		change_religion = religion:sunni
		change_religion_for_ruler_and_family = { country = ROOT religion = religion:sunni }
		if = {
			limit = { country_rank_level < 3 }
			set_country_rank_effect = { rank = country_rank:rank_kingdom }
		}

		ruler = {
			change_character_religion = religion:sunni
			set_first_name = name_muhammad
			dynasty ?= {
				every_character_in_dynasty = {
					limit = {
						owner = ROOT
						NOT = { this = ROOT.ruler }
					}
					change_character_religion = religion:sunni
				}
			}
		}

		capital = {
			every_pop = {
				limit = {
					religion = ROOT.religion
					culture = { is_primary_or_accepted_in = ROOT }
				}
				split_pop = {
					fraction = {
						value = 0.5
						multiply = pop_satisfaction
						if = { 
							limit = { NOT = { culture = ROOT.culture } }
							multiply = 0.5
						}
					}
					religion = religion:sunni
				}
			}
		}
	}

	option = {
		name = flavor_bei.1.b

		ruler = {
			change_character_religion = religion:sunni
			set_first_name = name_muhammad
		}

		capital = {
			every_pop = {
				limit = {
					religion = ROOT.religion
					culture = { is_primary_or_accepted_in = ROOT }
				}
				split_pop = {
					fraction = {
						value = 0.5
						multiply = {
							value = 1
							subtract = pop_satisfaction
						}
						if = { 
							limit = { NOT = { culture = ROOT.culture } }
							multiply = 0.5
						}
					}
					religion = religion:sunni
				}
			}
		}
	}
}