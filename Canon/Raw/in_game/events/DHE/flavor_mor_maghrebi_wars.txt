namespace = flavor_mor_maghrebi_wars


# root = country; scope:old_ruler and scope:new_ruler are supplied
#Event for Tunis
flavor_mor_maghrebi_wars.1000 = { #The Ambitious Brother #GRAVEYARD
	hide_portraits = yes
	type = country_event
	title = flavor_mor_maghrebi_wars.1000.title
	desc = flavor_mor_maghrebi_wars.1000.desc
	historical_info = flavor_mor_maghrebi_wars.1000.historical_info

	
	fire_only_once = yes
	
	illustration_tags = {
		10 = angry
		10 = interior
	}

	trigger = {
		tag = TUN
		scope:old_ruler = character:tun_abu_yahya_abu_bakr_ii
		scope:new_ruler = character:tun_abu_l_abbas_ahmad
		character:tun_abu_l_abbas_ahmad = {
			is_alive = yes
			is_ruler = yes		
		}
		character:tun_abu_hafs_umar = {
			is_alive = yes
			is_ruler = no	
		}
		
	}

	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		capital = {
			save_scope_as = capital_scope
		}
		character:tun_abu_l_abbas_ahmad = {
			save_scope_as = ruler_scope
		}
		character:tun_abu_hafs_umar = {
			save_scope_as = usurper_scope	
		}
		random_related_country = {
			type = alliance
			limit = { 
				not = { tag = MOR}
			}
			save_scope_as = ally_scope
		}
		kill_character = {
			target = scope:ruler_scope
			killer = scope:usurper_scope
			reason = assassination
		}
		set_new_ruler = scope:usurper_scope
	}

	option = {
		name = flavor_mor_maghrebi_wars.1000.a
		historical_option = yes
		hidden_effect = {
			c:MOR = {
				save_scope_as = ally_scope
			}
		}
		c:MOR = {	
			if = {
				limit = {
					NOT = { has_casus_belli_on = c:TUN }
				}
				add_casus_belli =  { 
					type = casus_belli:cb_annex
					target = c:TUN
					years = 10
				}
			}
			trigger_event_non_silently = {
				id = flavor_mor_maghrebi_wars.1004
				days = { 5 10 }
			}
		}

		add_prestige = prestige_severe_penalty
		add_legitimacy = legitimacy_ultimate_penalty
	}

	option = {
		name = flavor_mor_maghrebi_wars.1000.b
		trigger = { exists = scope:ally_scope }
		scope:ally_scope = {
			show_as_tooltip = {
				add_casus_belli =  { 
					type = casus_belli:cb_annex
					target = c:TUN
					years = 10
				}
			}
			trigger_event_non_silently = {
				id = flavor_mor_maghrebi_wars.1001
				days = { 5 10 }
			}
		}

		add_prestige = prestige_severe_penalty
		add_legitimacy = legitimacy_ultimate_penalty		
	}

	option = {
		name = flavor_mor_maghrebi_wars.1000.c
		add_all_estate_satisfaction = { value = estate_satisfaction_severe_penalty }
		add_legitimacy = legitimacy_ultimate_penalty
	}
}

#Event for an ally of Tunis
flavor_mor_maghrebi_wars.1001 = { #"The [ROOT.GetCountry.GetAdjectiveWithNoTooltip] succession" #GRAVEYARD
	type = country_event
	title = flavor_mor_maghrebi_wars.1001.title
	desc = flavor_mor_maghrebi_wars.1001.desc

	
	fire_only_once = yes
	
	illustration_tags = {
		10 = happy
		10 = interior
	}

	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		
		clear_saved_scope = ruler_scope
		clear_saved_scope = old_ruler
		clear_saved_scope = new_ruler
		clear_saved_scope = capital_scope
	}

	option = {
		name = flavor_mor_maghrebi_wars.1001.a	
		if = {
			limit = {
				NOT = { has_casus_belli_on = c:TUN }
			}
			add_casus_belli =  { 
				type = casus_belli:cb_annex
				target = c:TUN
				years = 10
			}
		}
		
		#If root is an ally of Tunis
		if = {
			limit = {				
				any_related_country = {
					type = alliance
					tag = TUN
				}
			}
			#If root is in a war together with Tunis
			if = {
				limit = {
					is_fighting_war_together_with = c:TUN
				}
				#Huge hit in opinion, so the AI breaks it when the war ends
				add_opinion = { target = c:TUN modifier = opinion_dishonored_alliance }
				reverse_add_opinion = { target = c:TUN modifier = opinion_declined_to_recognize_monarchy_modifier }
				
			}
			else = { #If not we just break the alliance
				remove_relation = {
					first = ROOT
					second = c:TUN
					type = relation_type:alliance
				}
			}
		}
		
		every_related_country = {
			type = alliance
			limit = { 
				NOT = { tag = TUN }
			}
			add_opinion = { target = ROOT modifier = opinion_irritated }
		}
		c:TUN = {
			trigger_event_non_silently = {
				id = flavor_mor_maghrebi_wars.1002
				days = { 5 10 }
			}
		}
	}

	option = {
		name = flavor_mor_maghrebi_wars.1001.b

		every_related_country = {
			type = alliance
			limit = { 
				NOT = { tag = TUN }
			}
			add_opinion = { target = ROOT modifier = opinion_supportive_monarch }
		}	
		add_prestige = prestige_severe_bonus
		c:TUN = {
			trigger_event_non_silently = {
				id = flavor_mor_maghrebi_wars.1003
				days = { 5 10 }
			}
		}
	}
}

#Event for Tunis, ally accepts
flavor_mor_maghrebi_wars.1002 = { #"The [ROOT.GetCountry.GetAdjectiveWithNoTooltip] succesion"
	type = country_event
	title = flavor_mor_maghrebi_wars.1002.title
	desc = flavor_mor_maghrebi_wars.1002.desc
	
	fire_only_once = yes
	
	illustration_tags = {
		10 = angry
		10 = exterior
	}

	immediate = {
		event_illustration_poptype_effect = { foreground = pop_type:nobles background = pop_type:soldiers }
		
		character:tun_abu_l_abbas_ahmad = {
			save_scope_as = dead_ruler_scope
		}
	}

	option = {
		name = flavor_mor_maghrebi_wars.1002.a
	}
}

#Event for Tunis, ally rejects
flavor_mor_maghrebi_wars.1003 = { #"The [ROOT.GetCountry.GetAdjectiveWithNoTooltip] succesion"
	type = country_event
	title = flavor_mor_maghrebi_wars.1003.title
	desc = flavor_mor_maghrebi_wars.1003.desc
	
	fire_only_once = yes
	
	illustration_tags = {
		10 = regular
		10 = exterior
	}

	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		
		character:tun_abu_l_abbas_ahmad = {
			save_scope_as = dead_ruler_scope
		}
	}

	option = {
		name = flavor_mor_maghrebi_wars.1003.a
	}
}

#Event for MOR
#The destiny of [ROOT.GetCountry.GetNameWithNoTooltip]"
flavor_mor_maghrebi_wars.1004 = {
	type = country_event

	title = flavor_mor_maghrebi_wars.1004.title
	desc = flavor_mor_maghrebi_wars.1004.desc
	historical_info = flavor_mor_maghrebi_wars.1004.historical_info
	
	fire_only_once = yes

	illustration_tags = {
		10 = armed
		10 = exterior
	}

	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }
		ruler = {
			save_scope_as = ruler_scope
		}
	}

	option = {
		name = flavor_mor_maghrebi_wars.1004.a
		historical_option = yes
				
		if = {
			limit = {
				NOT = { has_casus_belli_on = c:TUN }
			}
			add_casus_belli =  { 
				type = casus_belli:cb_annex
				target = c:TUN
				years = 10
			}
		}
		#If Morocco is an ally of Tunis
		if = {
			limit = {				
				any_related_country = {
					type = alliance
					tag = TUN
				}
			}
			#If Morocco is in a war together with Tunis
			if = {
				limit = {
					is_fighting_war_together_with = c:TUN
				}
				#Huge hit in opinion, so the AI breaks it when the war ends
				add_opinion = { target = c:TUN modifier = opinion_dishonored_alliance }
				reverse_add_opinion = { target = c:TUN modifier = opinion_declined_to_recognize_monarchy_modifier }
				
			}
			else = { #If not we just break the alliance
				remove_relation = {
					first = ROOT
					second = c:TUN
					type = relation_type:alliance
				}
			}
		}		

		every_related_country = {
			type = alliance
			limit = { 
				NOT = { tag = TUN }
			}
			add_opinion = { target = ROOT modifier = opinion_irritated }
		}
		c:TUN = {
			trigger_event_non_silently = {
				id = flavor_mor_maghrebi_wars.1002
				days = { 5 10 }
			}
		}
	}

	option = {
		name = flavor_mor_maghrebi_wars.1004.b
		every_related_country = {
			type = alliance
			limit = { 
				NOT = { tag = TUN }
			}
			add_opinion = { target = ROOT modifier = opinion_supportive_monarch }
		}	
		add_prestige = prestige_severe_bonus
		c:TUN = {
			trigger_event_non_silently = {
				id = flavor_mor_maghrebi_wars.1003
				days = { 5 10 }
			}
		}
	}
}

#Event for the unifier of Maghreb
flavor_mor_maghrebi_wars.1100 = { #"The [ROOT.GetCountry.GetAdjectiveWithNoTooltip] succesion"
	hide_portraits = yes
	type = country_event
	title = flavor_mor_maghrebi_wars.1100.title
	desc = flavor_mor_maghrebi_wars.1100.desc
	
	fire_only_once = yes
	
	illustration_tags = {
		10 = happy
		10 = exterior
	}

	trigger = {
        religion.group = religion_group:muslim
		province_definition:tunis_province = {
			any_location_in_province_definition = {
				top_owner ?= root
			}
		}
		province_definition:tlemcen_province = {
			any_location_in_province_definition = {
				top_owner ?= root
			}
		}
		province_definition:oran_province = {
			any_location_in_province_definition = {
				top_owner ?= root
			}
		}
		province_definition:fez_province = {
			any_location_in_province_definition = {
				top_owner ?= root
			}
		}
		province_definition:marrakesh_province = {
			any_location_in_province_definition = {
				top_owner ?= root
			}
		}
		province_definition:kabylia_province = {
			any_location_in_province_definition = {
				top_owner ?= root
			}
		}
	}

	immediate = {
		event_illustration_estate_effect = { foreground = estate_type:nobles_estate background = estate_type:nobles_estate }	
		religion = {
			save_scope_as = religion_scope
		}
		ruler = {
			save_scope_as = ruler_scope
		}
	}

	option = {
		name = flavor_mor_maghrebi_wars.1100.a
		historical_option = yes
		
		custom_tooltip = {
			text = flavor_mor_maghrebi_wars.1100.tt
			religion = { 
				every_country_in_religion = {
					limit = {
						NOT = { this = ROOT }
						within_diplomatic_range = ROOT
					}
					add_opinion = { target = ROOT modifier = opinion_supportive_monarch }
				}
			}
		}
	}
}