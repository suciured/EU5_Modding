namespace = noble_marriage


scripted_trigger valid_female_for_ruler = {
	is_female = yes
	is_adult = yes
	age_in_years < 25
	is_married = no
	NOT = { is_close_relative = root.ruler }
}


noble_marriage.1 = {
	type = country_event
	title = noble_marriage.1.title
	desc = noble_marriage.1.desc

	image = "gfx/interface/illustrations/government/diplomacy_illustration.dds"

	trigger = {
		government_type = government_type:monarchy
		has_ruler_in_country = yes
		ruler ?= {
			has_dynasty = yes
			is_married = no
			is_female = no
			age_in_years > 21
		}
		any_dynasty = {
			trigger_if = {
				limit = {
					root = {
						has_ruler_in_country = yes
						ruler ?= {
							has_dynasty = yes
						}
					}
				}
				this != root.ruler.dynasty
			}
			any_character_in_dynasty = {
				valid_female_for_ruler = yes
			}
		}
	}
	
	immediate = {
		random_dynasty = {
			limit = {
				trigger_if = {
					limit = {
						root = {
							has_ruler_in_country = yes
							ruler ?= {
								has_dynasty = yes
							}
						}
					}
					this != root.ruler.dynasty
				}
				any_character_in_dynasty = {
					valid_female_for_ruler = yes
				}
			}
			random_character_in_dynasty = {
				limit = {
					valid_female_for_ruler = yes
				}
				add_character_modifier = {
					modifier = block_marriage
					years = -1
					mode = add_and_extend
					recalculate_immediately = yes #only because it will be used immediately
				}
				save_scope_as = target
			}
		}
	}

	option = {
		name = noble_marriage.1.a
		hidden_effect = {
			ruler ?= {	remove_character_modifier = block_marriage	}
			scope:target ?= { remove_character_modifier = block_marriage	}
		}
		ruler ?= {  scope:target ?= { marry_character = prev } }
		add_estate_satisfaction = { type = estate_type:nobles_estate value = estate_satisfaction_mild_bonus }
		add_estate_satisfaction = { type = estate_type:peasants_estate value = estate_satisfaction_mild_penalty }

	}
	option = {
		name = noble_marriage.1.b
		hidden_effect = {
			ruler ?= {	remove_character_modifier = block_marriage	}
			scope:target ?= { remove_character_modifier = block_marriage	}
		}
		add_estate_satisfaction = { type = estate_type:nobles_estate value = estate_satisfaction_extreme_penalty }
	}
}



scripted_trigger valid_female_for_heir = {
	is_female = yes
	is_adult = yes
	age_in_years < 25
	is_married = no
	NOT = { is_close_relative = root.heir }
}


noble_marriage.2 = {
	type = country_event
	title = noble_marriage.2.title
	desc = noble_marriage.2.desc

	image = "gfx/interface/illustrations/government/diplomacy_illustration.dds"
	trigger = {
		government_type = government_type:monarchy
		has_heir = yes
		has_ruler_in_country = yes
		ruler = { has_dynasty = yes }
		heir ?= {
			is_married = no
			is_female = no
			age_in_years > 21
			has_dynasty = yes
			dynasty = root.ruler.dynasty
		}

		any_dynasty = { 
			this != root.ruler.dynasty
			
			any_character_in_dynasty = {
				valid_female_for_heir = yes
			}
			count > 0
		}
	}
	
	immediate = {
		random_dynasty = {
			limit = {
				this != root.heir.dynasty
				any_character_in_dynasty = {
					valid_female_for_heir = yes
				}
			}
			random_character_in_dynasty = {
				limit = {
					valid_female_for_heir = yes
				}
				add_character_modifier = {
					modifier = block_marriage
					years = -1
					mode = add_and_extend
					recalculate_immediately = yes #only because it will be used immediately
				}
				save_scope_as = target
			}
		}
	}

	option = {
		name = noble_marriage.2.a
		hidden_effect = {
			ruler ?= {	remove_character_modifier = block_marriage	}
			scope:target = { remove_character_modifier = block_marriage	}
		}
		heir ?= { marry_character = scope:target }
		add_estate_satisfaction = { type = estate_type:nobles_estate value = estate_satisfaction_mild_bonus }
		add_estate_satisfaction = { type = estate_type:peasants_estate value = estate_satisfaction_mild_penalty }

	}
	option = {
		name = noble_marriage.2.b
		hidden_effect = {
			ruler ?= {	remove_character_modifier = block_marriage	}
			scope:target = { remove_character_modifier = block_marriage	}
		}
		add_estate_satisfaction = { type = estate_type:nobles_estate value = estate_satisfaction_extreme_penalty }
	}
}




scripted_trigger valid_male_for_ruler = {
	is_female =  no
	is_adult = yes
	age_in_years > 25
	age_in_years < 40
	is_married = no
	NOT = { is_close_relative = root.ruler }
}


noble_marriage.3 = {
	hide_portraits = yes
	type = country_event
	title = noble_marriage.3.title
	desc = noble_marriage.3.desc

	image = "gfx/interface/illustrations/government/diplomacy_illustration.dds"
	trigger = {
		government_type = government_type:monarchy
		has_ruler_in_country = yes
		ruler ?= {
			has_dynasty = yes
			is_married = no
			is_female = yes
			age_in_years > 20
			age_in_years < 40
		}

		any_dynasty = { 
			this != root.ruler.dynasty
			
			any_character_in_dynasty = {
				valid_male_for_ruler = yes
			}
			count > 0
		}
	}
	
	immediate = {
		ruler = {
			add_character_modifier = {
				modifier = block_marriage
				years = -1
				mode = add_and_extend
				recalculate_immediately = yes #only because it will be used immediately
			}
		}
		random_dynasty = {
			limit = {
				this != root.ruler.dynasty
				any_character_in_dynasty = {
					valid_male_for_ruler = yes
				}
			}
			random_character_in_dynasty = {
				limit = {
					valid_male_for_ruler = yes
				}
				
				add_character_modifier = {
					modifier = block_marriage
					years = -1
					mode = add_and_extend
					recalculate_immediately = yes #only because it will be used immediately
				}
				
				save_scope_as = target
			}
		}
	}

	option = {
		name = noble_marriage.3.a
		hidden_effect = {
			ruler ?= {	remove_character_modifier = block_marriage	}
			scope:target = { remove_character_modifier = block_marriage	}
		}
		ruler ?= { marry_character = scope:target }
		add_estate_satisfaction = { type = estate_type:nobles_estate value = estate_satisfaction_mild_bonus }
	}
	option = {
		name = noble_marriage.3.b
		hidden_effect = {
			ruler ?= {	remove_character_modifier = block_marriage	}
			scope:target = { remove_character_modifier = block_marriage	}
		}
		add_estate_satisfaction = { type = estate_type:nobles_estate value = estate_satisfaction_extreme_penalty }
		add_stability = stability_mild_penalty
	}
}





###########################################################
# Dynasty Head asks to marry female relative of ruler
###########################################################

scripted_trigger valid_female_of_ruler_dynasty = {
	is_female =  yes
	is_adult = yes
	age_in_years > 19
	age_in_years < 30
	is_married = no
	is_heir = no
	is_ruler =  no
	modifier:blocked_from_marriage = no
	NOT = { has_estate = estate_type:clergy_estate }
}

scripted_trigger valid_dynasty_head = {
	is_female =  no
	is_adult = yes
	age_in_years > 25
	is_married = no
	modifier:blocked_from_marriage = no
	NOT = { has_estate = estate_type:clergy_estate }
}




noble_marriage.4 = {
	type = country_event
	title = noble_marriage.4.title
	desc = noble_marriage.4.desc

	image = "gfx/interface/illustrations/government/diplomacy_illustration.dds"
	trigger = {
		government_type = government_type:monarchy
		has_ruler_in_country = yes
		ruler = { has_dynasty = yes }
		ruler.dynasty ?= {
			any_character_in_dynasty = {
				valid_female_of_ruler_dynasty = yes
			}
			save_temporary_scope_as = target_dynasty
		}
		any_dynasty = {
			exists = scope:target_dynasty
			NOT = { this = scope:target_dynasty }
			dynasty_head ?= {
				valid_dynasty_head = yes
			}
		}
		
	}
	
	immediate = {
		ruler.dynasty = { save_scope_as = target_dynasty }
		random_dynasty = {
			limit = {
				exists = scope:target_dynasty
				NOT = { this = scope:target_dynasty }
				dynasty_head ?= {
					valid_dynasty_head = yes
				}
				
			}
			dynasty_head = {
				add_character_modifier = {
					modifier = block_marriage
					years = -1
					mode = add_and_extend
					recalculate_immediately = yes #only because it will be used immediately
				}
				save_scope_as = male_target
			}
		}
		
		ruler.dynasty ?= {
			random_character_in_dynasty = {
				limit = {
					valid_female_of_ruler_dynasty = yes
				}
				add_character_modifier = {
					modifier = block_marriage
					years = -1
					mode = add_and_extend
					recalculate_immediately = yes #only because it will be used immediately
				}
				save_scope_as = female_target
			}
		}
		
	}

	option = {
		name = noble_marriage.4.a
		hidden_effect = {
			scope:male_target ?= {	remove_character_modifier = block_marriage	}
			scope:female_target ?= { remove_character_modifier = block_marriage	}
		}
		scope:female_target ?= { marry_character = scope:male_target }
		add_estate_satisfaction = { type = estate_type:nobles_estate value = estate_satisfaction_mild_bonus }
	}
	option = {
		name = noble_marriage.4.b
		hidden_effect = {
			scope:male_target ?= {	remove_character_modifier = block_marriage	}
			scope:female_target ?= { remove_character_modifier = block_marriage	}
		}
		if = {
			limit = {
				has_estate_privilege = estate_privilege:noble_marriage_rights 
			}
			add_estate_satisfaction = { type = estate_type:nobles_estate value = estate_satisfaction_extreme_penalty }
			add_stability = stability_mild_penalty
		}
		else = {
			add_prestige = prestige_mild_penalty
		}
	}
}
